[file name]: 2.3_Consumer.txt
[file content begin]
–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è 2.3: –ö–æ–Ω—Å—é–º–µ—Ä—ã Apache Kafka –Ω–∞ Python

–¶–µ–ª—å: –û—Å–≤–æ–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–¥–µ–∂–Ω—ã—Ö –∫–æ–Ω—Å—é–º–µ—Ä–æ–≤ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º offset
–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 40-50 –º–∏–Ω—É—Ç
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ: 
1. –†–∞–±–æ—á–∏–π –∫–ª–∞—Å—Ç–µ—Ä Kafka –∏–∑ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π 1
2. Python 3.8+ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ –õ–∞–±—ã 2.2
3. –¢–æ–ø–∏–∫ —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è (—Å–æ–∑–¥–∞–¥–∏–º)

# ============================================
# 0. –ü–û–î–ì–û–¢–û–í–ö–ê –û–ö–†–£–ñ–ï–ù–ò–Ø –ò –ü–†–û–í–ï–†–ö–ê
# ============================================

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
echo "–°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏..."

cat > setup_demo.py << 'EOF'
#!/usr/bin/env python3
"""
–ù–ê–°–¢–†–û–ô–ö–ê –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–ò –î–õ–Ø –õ–ê–ë–û–†–ê–¢–û–†–ù–û–ô 2.3

–ß—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫—É –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–π
2. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ç–æ–ø–∏–∫–∞ —Å 6 –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏ –∏ 3 —Ä–µ–ø–ª–∏–∫–∞–º–∏
3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—é 5000 —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤
4. –ü—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Kafka –∫–ª–∞—Å—Ç–µ—Ä–∞

–ö–æ–Ω—Ü–µ–ø—Ü–∏–∏ Kafka:
- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–ø–∏–∫–æ–≤ —á–µ—Ä–µ–∑ Kafka CLI
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –ø–∞—Ä—Ç–∏—Ü–∏—è–º (partitioning)
- –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏
- –û—Å–Ω–æ–≤—ã —Ä–∞–±–æ—Ç—ã Producer API

–ó–∞–ø—É—Å–∫:
python3 setup_demo.py

–†–µ–∑—É–ª—å—Ç–∞—Ç:
–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω —Ç–æ–ø–∏–∫ 'user-actions' —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –≤—Å–µ—Ö –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤.
"""

import subprocess
import json
import time
from confluent_kafka import Producer

def create_topic():
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–ø–∏–∫–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏"""
    print("üìù –ü—Ä–æ–≤–µ—Ä—è—é –∏ —Å–æ–∑–¥–∞—é —Ç–æ–ø–∏–∫ 'user-actions'...")
    
    cmd = [
        '/opt/kafka/bin/kafka-topics.sh',
        '--create',
        '--bootstrap-server', 'localhost:9092',
        '--topic', 'user-actions',
        '--partitions', '6',
        '--replication-factor', '3'
    ]
    
    try:
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=10)
        if result.returncode == 0:
            print("‚úÖ –¢–æ–ø–∏–∫ 'user-actions' —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ")
            return True
        elif "already exists" in result.stderr:
            print("‚ÑπÔ∏è  –¢–æ–ø–∏–∫ 'user-actions' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
            return True
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ–ø–∏–∫–∞: {result.stderr}")
            return False
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        return False

def produce_test_messages():
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    print("\nüì® –°–æ–∑–¥–∞—é —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è...")
    
    conf = {'bootstrap.servers': 'localhost:9092'}
    producer = Producer(conf)
    
    messages_sent = 0
    
    def delivery_report(err, msg):
        nonlocal messages_sent
        if err is not None:
            print(f'‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏: {err}')
        else:
            messages_sent += 1
            if messages_sent % 500 == 0:
                print(f"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {messages_sent} —Å–æ–æ–±—â–µ–Ω–∏–π...")
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º 5000 —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    for i in range(5000):
        message = {
            'event_id': f'event_{i}',
            'user_id': f'user_{i % 100}',
            'action': ['login', 'logout', 'purchase', 'view', 'search'][i % 5],
            'timestamp': int(time.time() * 1000),
            'data': f'–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ {i} –¥–ª—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç—ã'
        }
        
        producer.produce(
            'user-actions',
            key=str(i % 6),  # –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ –ø–∞—Ä—Ç–∏—Ü–∏—è–º
            value=json.dumps(message, ensure_ascii=False),
            callback=delivery_report
        )
        producer.poll(0)
    
    producer.flush()
    print(f"‚úÖ –í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {messages_sent} —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ç–æ–ø–∏–∫ 'user-actions'")
    return True

def describe_topic():
    """–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–ø–∏–∫–∞"""
    print("\nüìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–ø–∏–∫–µ 'user-actions':")
    
    cmd = [
        '/opt/kafka/bin/kafka-topics.sh',
        '--describe',
        '--bootstrap-server', 'localhost:9092',
        '--topic', 'user-actions'
    ]
    
    try:
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=5)
        if result.returncode == 0:
            print(result.stdout)
            return True
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞: {result.stderr}")
            return False
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        return False

def main():
    print("=" * 80)
    print("–ù–ê–°–¢–†–û–ô–ö–ê –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–ò –î–õ–Ø –õ–ê–ë–û–†–ê–¢–û–†–ù–û–ô 2.3")
    print("=" * 80)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Kafka
    print("\nüîç –ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Kafka...")
    try:
        cmd = ['/opt/kafka/bin/kafka-topics.sh', '--list', '--bootstrap-server', 'localhost:9092']
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=5)
        
        if result.returncode != 0:
            print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Kafka")
            print("   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Kafka –∑–∞–ø—É—â–µ–Ω–∞: sudo systemctl start kafka")
            return
        
        print("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Kafka —É—Å–ø–µ—à–Ω–æ")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")
        return
    
    # –°–æ–∑–¥–∞–µ–º —Ç–æ–ø–∏–∫
    if not create_topic():
        print("\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–æ–ø–∏–∫. –í—ã—Ö–æ–¥.")
        return
    
    # –û–ø–∏—Å—ã–≤–∞–µ–º —Ç–æ–ø–∏–∫
    describe_topic()
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    print("\n" + "=" * 80)
    choice = input("–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (5000 —Å–æ–æ–±—â–µ–Ω–∏–π)? (y/n): ").strip().lower()
    
    if choice == 'y':
        if produce_test_messages():
            print("\n‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!")
            print("\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã:")
            print("  1. python3 basic_consumer.py")
            print("  2. python3 manual_commit_consumer.py --id consumer-1")
            print("  3. python3 consumer_group_demo.py")
            print("  4. python3 error_handling_consumer.py")
            print("  5. python3 rebalance_test.py")
        else:
            print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è")
    else:
        print("‚ÑπÔ∏è  –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π")
        print("\n‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ö–æ–Ω—Å—é–º–µ—Ä—ã –º–æ–≥—É—Ç –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é,")
        print("   –µ—Å–ª–∏ –≤ —Ç–æ–ø–∏–∫–µ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nüëã –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞")
    except Exception as e:
        print(f"\n‚ùå –û—à–∏–±–∫–∞: {e}")
EOF

echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
echo "python3 setup_demo.py"
echo ""
echo "–ù–∞ –≤–æ–ø—Ä–æ—Å –æ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç–≤–µ—Ç—å—Ç–µ 'y'"
echo "–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—É—é —Ä–∞–±–æ—Ç—É."
echo ""
read -p "–ù–∞–∂–º–∏—Ç–µ Enter, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å..." dummy

# ============================================
# 1. –ë–ê–ó–û–í–´–ô –ö–û–ù–°–Æ–ú–ï–† (–ê–í–¢–û–ö–û–ú–ú–ò–¢)
# ============================================

echo "–°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π –∫–æ–Ω—Å—é–º–µ—Ä —Å –∞–≤—Ç–æ–∫–æ–º–º–∏—Ç–æ–º..."

cat > basic_consumer.py << 'EOF'
#!/usr/bin/env python3
"""
–ë–ê–ó–û–í–´–ô –ö–û–ù–°–Æ–ú–ï–† KAFKA –° –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ú –ö–û–ú–ú–ò–¢–û–ú

–ß—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
1. –ü—Ä–æ—Å—Ç–µ–π—à—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é Kafka Consumer
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–∏—Ç offset (enable.auto.commit = True)
3. –û—Å–Ω–æ–≤—ã –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Ç–æ–ø–∏–∫ –∏ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
4. Graceful shutdown –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ (SIGINT, SIGTERM)

–ö–æ–Ω—Ü–µ–ø—Ü–∏–∏ Kafka:
- Consumer Groups –∏ group.id
- Auto offset commit (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏)
- Auto offset reset (earliest/latest)
- –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, –Ω–æ —Ä–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö
- –ê–≤—Ç–æ–∫–æ–º–º–∏—Ç –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
- –ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏ exactly-once –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ó–∞–ø—É—Å–∫:
python3 basic_consumer.py

–†–µ–∑—É–ª—å—Ç–∞—Ç:
–ö–æ–Ω—Å—é–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç 100 —Å–æ–æ–±—â–µ–Ω–∏–π, –ø–æ–∫–∞–∂–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è.
–í—ã —É–≤–∏–¥–∏—Ç–µ –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø–æ –ø–∞—Ä—Ç–∏—Ü–∏—è–º.
"""

from confluent_kafka import Consumer, KafkaError
import json
import time
import signal
import sys
from rich.console import Console
from rich.table import Table
from rich.progress import Progress
from datetime import datetime
import subprocess

console = Console()

def check_topic_exists(topic="user-actions"):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–æ–ø–∏–∫–∞"""
    try:
        cmd = ['/opt/kafka/bin/kafka-topics.sh', '--describe', 
               '--bootstrap-server', 'localhost:9092', '--topic', topic]
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=5)
        
        if result.returncode != 0 or f"Topic: {topic}" not in result.stdout:
            return False
        return True
    except Exception:
        return False

class BasicConsumer:
    def __init__(self, bootstrap_servers, group_id, topic):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑–æ–≤–æ–≥–æ –∫–æ–Ω—Å—é–º–µ—Ä–∞
        
        Args:
            bootstrap_servers: —Å—Ç—Ä–æ–∫–∞ —Å –∞–¥—Ä–µ—Å–∞–º–∏ –±—Ä–æ–∫–µ—Ä–æ–≤
            group_id: –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≥—Ä—É–ø–ø—ã –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π
            topic: —Ç–æ–ø–∏–∫ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏
        """
        self.config = {
            'bootstrap.servers': bootstrap_servers,
            'group.id': group_id,
            'auto.offset.reset': 'earliest',  # –ù–∞—á–∏–Ω–∞–µ–º —Å –Ω–∞—á–∞–ª–∞ —Ç–æ–ø–∏–∫–∞
            'enable.auto.commit': True,       # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–∏—Ç offset
            'auto.commit.interval.ms': 5000,  # –ö–æ–º–º–∏—Ç–∏–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            'session.timeout.ms': 10000,      # –¢–∞–π–º–∞—É—Ç —Å–µ—Å—Å–∏–∏
            'max.poll.interval.ms': 300000,   # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        }
        
        self.consumer = Consumer(self.config)
        self.topic = topic
        self.running = True
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        self.stats = {
            'messages_processed': 0,
            'errors': 0,
            'start_time': None,
            'last_commit': time.time(),
            'offsets': {}
        }
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è graceful shutdown
        signal.signal(signal.SIGINT, self.signal_handler)
        signal.signal(signal.SIGTERM, self.signal_handler)
    
    def signal_handler(self, signum, frame):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è graceful shutdown"""
        console.print(f"\n[yellow]‚ö†Ô∏è  –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª {signum}, –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É...[/yellow]")
        self.running = False
    
    def process_message(self, message):
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        
        Args:
            message: –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è Kafka
        """
        try:
            # –î–µ–∫–æ–¥–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            value = message.value().decode('utf-8')
            data = json.loads(value)
            
            # –ü—Ä–æ—Å—Ç–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
            console.print(f"\n[cyan]üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:[/cyan]")
            console.print(f"  Partition: {message.partition()}")
            console.print(f"  Offset: {message.offset()}")
            console.print(f"  Key: {message.key().decode('utf-8') if message.key() else 'None'}")
            console.print(f"  Event ID: {data.get('event_id', 'N/A')}")
            console.print(f"  User ID: {data.get('user_id', 'N/A')}")
            console.print(f"  Action: {data.get('action', 'N/A')}")
            console.print(f"  Timestamp: {data.get('timestamp', 'N/A')}")
            
            # –ò–º–∏—Ç–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            time.sleep(0.01)
            
            self.stats['messages_processed'] += 1
            return True
            
        except json.JSONDecodeError as e:
            console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JSON: {e}[/red]")
            self.stats['errors'] += 1
            return False
        except Exception as e:
            console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: {e}[/red]")
            self.stats['errors'] += 1
            return False
    
    def consume(self, max_messages=None):
        """
        –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
        
        Args:
            max_messages: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        """
        console.print(f"[bold green]üöÄ –ó–∞–ø—É—Å–∫ –±–∞–∑–æ–≤–æ–≥–æ –∫–æ–Ω—Å—é–º–µ—Ä–∞[/bold green]")
        console.print(f"üë• Group ID: {self.config['group.id']}")
        console.print(f"üì≠ –¢–æ–ø–∏–∫: {self.topic}")
        console.print(f"ü§ñ –ê–≤—Ç–æ–∫–æ–º–º–∏—Ç: {'–í–∫–ª—é—á–µ–Ω' if self.config['enable.auto.commit'] else '–í—ã–∫–ª—é—á–µ–Ω'}")
        
        self.consumer.subscribe([self.topic])
        self.stats['start_time'] = time.time()
        
        message_count = 0
        
        with Progress() as progress:
            task = progress.add_task("–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π...", total=max_messages)
            
            while self.running:
                if max_messages and message_count >= max_messages:
                    console.print(f"\n[yellow]‚ö†Ô∏è  –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç {max_messages} —Å–æ–æ–±—â–µ–Ω–∏–π[/yellow]")
                    break
                
                try:
                    # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–∞–π–º–∞—É—Ç–æ–º 1 —Å–µ–∫—É–Ω–¥–∞
                    msg = self.consumer.poll(timeout=1.0)
                    
                    if msg is None:
                        continue
                    
                    if msg.error():
                        if msg.error().code() == KafkaError._PARTITION_EOF:
                            console.print(f"[yellow]üì≠ –î–æ—Å—Ç–∏–≥–Ω—É—Ç –∫–æ–Ω–µ—Ü –ø–∞—Ä—Ç–∏—Ü–∏–∏ {msg.partition()}[/yellow]")
                        else:
                            console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ Kafka: {msg.error()}[/red]")
                        continue
                    
                    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    if self.process_message(msg):
                        message_count += 1
                        
                        # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                        if max_messages:
                            progress.update(task, advance=1)
                        
                        # –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                        if message_count % 100 == 0:
                            self.show_stats()
                    
                except KeyboardInterrupt:
                    console.print("\n[yellow]‚ö†Ô∏è  –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º[/yellow]")
                    break
                except Exception as e:
                    console.print(f"[red]‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}[/red]")
                    self.stats['errors'] += 1
        
        # –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É
        self.close()
    
    def show_stats(self):
        """–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        current_time = time.time()
        duration = current_time - self.stats['start_time']
        
        if duration > 0:
            rate = self.stats['messages_processed'] / duration
        else:
            rate = 0
        
        console.print(f"\n[bold]üìä –¢–µ–∫—É—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:[/bold]")
        console.print(f"  –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {self.stats['messages_processed']}")
        console.print(f"  –û—à–∏–±–æ–∫: {self.stats['errors']}")
        console.print(f"  –°–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏: {rate:.2f} —Å–æ–æ–±—â/—Å–µ–∫")
        console.print(f"  –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: {duration:.2f} —Å–µ–∫")
    
    def close(self):
        """–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Å—é–º–µ—Ä–∞"""
        console.print("\n[yellow]üîí –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Å—é–º–µ—Ä–∞...[/yellow]")
        
        # –í—ã–≤–æ–¥–∏–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        console.print("\n[bold green]üìà –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:[/bold green]")
        self.show_stats()
        
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Å—é–º–µ—Ä
        self.consumer.close()
        console.print("[green]‚úÖ –ö–æ–Ω—Å—é–º–µ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫—Ä—ã—Ç[/green]")

if __name__ == "__main__":
    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    BOOTSTRAP_SERVERS = "localhost:9092"
    GROUP_ID = "basic-consumer-group"
    TOPIC = "user-actions"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–æ–ø–∏–∫–∞
    if not check_topic_exists(TOPIC):
        console.print("[red]‚ùå –¢–æ–ø–∏–∫ 'user-actions' –Ω–µ –Ω–∞–π–¥–µ–Ω![/red]")
        console.print("[yellow]üìå –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –æ–∫—Ä—É–∂–µ–Ω–∏—è:[/yellow]")
        console.print("[yellow]   python3 setup_demo.py[/yellow]")
        sys.exit(1)
    
    # –°–æ–∑–¥–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Å—é–º–µ—Ä
    consumer = BasicConsumer(BOOTSTRAP_SERVERS, GROUP_ID, TOPIC)
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º 100 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
    consumer.consume(max_messages=100)
EOF

echo "–ó–∞–ø—É—Å–∫–∞–µ–º –±–∞–∑–æ–≤—ã–π –∫–æ–Ω—Å—é–º–µ—Ä..."
python3 basic_consumer.py

# ============================================
# 2. –ö–û–ù–°–Æ–ú–ï–† –° –†–£–ß–ù–´–ú –ö–û–ú–ú–ò–¢–û–ú OFFSET
# ============================================

echo "–°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Å—é–º–µ—Ä —Å —Ä—É—á–Ω—ã–º –∫–æ–º–º–∏—Ç–æ–º offset..."

cat > manual_commit_consumer.py << 'EOF'
#!/usr/bin/env python3
"""
–ö–û–ù–°–Æ–ú–ï–† –° –†–£–ß–ù–´–ú –£–ü–†–ê–í–õ–ï–ù–ò–ï–ú OFFSET (MANUAL COMMIT)

–ß—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
1. –†—É—á–Ω–æ–π –∫–æ–º–º–∏—Ç offset –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ exactly-once —Å–µ–º–∞–Ω—Ç–∏–∫–∏
2. –û–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ (retry logic)
3. Callback'–∏ –¥–ª—è —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ (on_assign, on_revoke, on_lost)
4. Dead Letter Queue (DLQ) –¥–ª—è –Ω–µ—É–¥–∞—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
5. Thread-safe –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏

–ö–æ–Ω—Ü–µ–ø—Ü–∏–∏ Kafka:
- –†—É—á–Ω–æ–π –∫–æ–º–º–∏—Ç offset (enable.auto.commit = False)
- Consumer rebalance callbacks
- Exactly-once –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- Partition assignment strategies
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑
- –¢—Ä–µ–±—É–µ—Ç —è–≤–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ consumer.commit()
- –°–ª–æ–∂–Ω–µ–µ –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏, –Ω–æ –Ω–∞–¥–µ–∂–Ω–µ–µ
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ó–∞–ø—É—Å–∫:
python3 manual_commit_consumer.py --id consumer-1 --messages 50

–†–µ–∑—É–ª—å—Ç–∞—Ç:
–ö–æ–Ω—Å—é–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ä—É—á–Ω—ã–º –∫–æ–º–º–∏—Ç–æ–º,
–ø–æ–∫–∞–∂–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —É—Å–ø–µ—à–Ω—ã–º/–Ω–µ—É–¥–∞—á–Ω—ã–º –æ–±—Ä–∞–±–æ—Ç–∫–∞–º –∏ —Å–æ–∑–¥–∞—Å—Ç DLQ —Ñ–∞–π–ª.
"""

from confluent_kafka import Consumer, KafkaError, TopicPartition
import json
import time
import signal
import sys
from rich.console import Console
from rich.table import Table
from collections import defaultdict
import threading
import subprocess

console = Console()

def check_topic_exists(topic="user-actions"):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–æ–ø–∏–∫–∞"""
    try:
        cmd = ['/opt/kafka/bin/kafka-topics.sh', '--describe', 
               '--bootstrap-server', 'localhost:9092', '--topic', topic]
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=5)
        
        if result.returncode != 0 or f"Topic: {topic}" not in result.stdout:
            return False
        return True
    except Exception:
        return False

class ManualCommitConsumer:
    def __init__(self, bootstrap_servers, group_id, topic, consumer_id="consumer-1"):
        """
        –ö–æ–Ω—Å—é–º–µ—Ä —Å —Ä—É—á–Ω—ã–º –∫–æ–º–º–∏—Ç–æ–º offset
        
        Args:
            bootstrap_servers: —Å—Ç—Ä–æ–∫–∞ —Å –∞–¥—Ä–µ—Å–∞–º–∏ –±—Ä–æ–∫–µ—Ä–æ–≤
            group_id: –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≥—Ä—É–ø–ø—ã –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π
            topic: —Ç–æ–ø–∏–∫ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏
            consumer_id: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–æ–Ω—Å—é–º–µ—Ä–∞
        """
        self.config = {
            'bootstrap.servers': bootstrap_servers,
            'group.id': group_id,
            'auto.offset.reset': 'earliest',
            'enable.auto.commit': False,  # –í–´–ö–õ–Æ–ß–ê–ï–ú –∞–≤—Ç–æ–∫–æ–º–º–∏—Ç!
            'session.timeout.ms': 10000,
            'max.poll.interval.ms': 300000,
            'partition.assignment.strategy': 'roundrobin',
        }
        
        self.consumer = Consumer(self.config)
        self.topic = topic
        self.consumer_id = consumer_id
        self.running = True
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        self.stats = {
            'messages_processed': 0,
            'messages_committed': 0,
            'messages_failed': 0,
            'commits_successful': 0,
            'commits_failed': 0,
            'rebalances': 0,
            'start_time': time.time(),
        }
        
        # –•—Ä–∞–Ω–∏–º offset'—ã –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∫–æ–º–º–∏—Ç–∞
        self.pending_offsets = defaultdict(dict)  # partition -> {offset: message_data}
        self.committed_offsets = {}  # partition -> –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç–Ω—É—Ç—ã–π offset
        
        # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è thread-safe –æ–ø–µ—Ä–∞—Ü–∏–π
        self.lock = threading.Lock()
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤
        signal.signal(signal.SIGINT, self.signal_handler)
        signal.signal(signal.SIGTERM, self.signal_handler)
        
        # –¢–∞–π–º–µ—Ä –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–º–º–∏—Ç–∞
        self.commit_timer = threading.Timer(10.0, self.periodic_commit)
        self.commit_timer.daemon = True
        self.commit_timer.start()
    
    def signal_handler(self, signum, frame):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤"""
        console.print(f"\n[yellow]‚ö†Ô∏è  [{self.consumer_id}] –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª {signum}[/yellow]")
        self.running = False
    
    def on_assign(self, consumer, partitions):
        """Callback –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –ø–∞—Ä—Ç–∏—Ü–∏–π"""
        console.print(f"\n[green]‚úÖ [{self.consumer_id}] –ù–∞–∑–Ω–∞—á–µ–Ω—ã –ø–∞—Ä—Ç–∏—Ü–∏–∏:[/green]")
        for p in partitions:
            console.print(f"  Partition {p.partition} (offset: {p.offset})")
            self.committed_offsets[p.partition] = p.offset
        
        self.stats['rebalances'] += 1
    
    def on_revoke(self, consumer, partitions):
        """Callback –ø—Ä–∏ –æ—Ç–∑—ã–≤–µ –ø–∞—Ä—Ç–∏—Ü–∏–π (–ø–µ—Ä–µ–¥ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–æ–π)"""
        console.print(f"\n[yellow]üîÑ [{self.consumer_id}] –†–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞! –û—Ç–∑—ã–≤ –ø–∞—Ä—Ç–∏—Ü–∏–π...[/yellow]")
        
        # –ö–û–ú–ú–ò–¢–ò–ú –í–°–ï –û–ñ–ò–î–ê–Æ–©–ò–ï OFFSET'–´ –ø–µ—Ä–µ–¥ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–æ–π
        self.commit_offsets(force=True)
        
        for p in partitions:
            console.print(f"  Partition {p.partition}")
    
    def on_lost(self, consumer, partitions):
        """Callback –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ –ø–∞—Ä—Ç–∏—Ü–∏–π (–ø–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞)"""
        console.print(f"\n[red]üí• [{self.consumer_id}] –ü–æ—Ç–µ—Ä—è–Ω—ã –ø–∞—Ä—Ç–∏—Ü–∏–∏![/red]")
        for p in partitions:
            console.print(f"  Partition {p.partition}")
    
    def process_message_with_retry(self, msg, max_retries=3):
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
        
        Args:
            msg: —Å–æ–æ–±—â–µ–Ω–∏–µ Kafka
            max_retries: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
        """
        for attempt in range(max_retries):
            try:
                # –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
                value = msg.value().decode('utf-8')
                data = json.loads(value)
                
                # –ò–º–∏—Ç–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 5%)
                if attempt == 0 and time.time() % 100 < 5:  # 5% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—à–∏–±–∫–∏
                    raise Exception("–°–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏")
                
                # –£—Å–ø–µ—à–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
                console.print(f"\n[green]‚úÖ [{self.consumer_id}] –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ:[/green]")
                console.print(f"  Partition: {msg.partition()}, Offset: {msg.offset()}")
                console.print(f"  User: {data.get('user_id', 'N/A')[:8]}..., Action: {data.get('action', 'N/A')}")
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –∫–æ–º–º–∏—Ç–∞
                with self.lock:
                    self.pending_offsets[msg.partition()][msg.offset()] = {
                        'data': data,
                        'processed_at': time.time()
                    }
                
                self.stats['messages_processed'] += 1
                return True
                
            except Exception as e:
                if attempt < max_retries - 1:
                    wait_time = 2 ** attempt  # –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
                    console.print(f"[yellow]üîÑ [{self.consumer_id}] –ü–æ–ø—ã—Ç–∫–∞ {attempt+1}/{max_retries} –Ω–µ —É–¥–∞–ª–∞—Å—å: {e}")
                    console.print(f"[yellow]   –ñ–¥–µ–º {wait_time} —Å–µ–∫—É–Ω–¥...[/yellow]")
                    time.sleep(wait_time)
                else:
                    console.print(f"[red]‚ùå [{self.consumer_id}] –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ —É–¥–∞–ª–∏—Å—å –¥–ª—è offset {msg.offset()}[/red]")
                    self.stats['messages_failed'] += 1
                    
                    # –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Dead Letter Queue
                    self.send_to_dlq(msg, str(e))
                    return False
        
        return False
    
    def send_to_dlq(self, msg, error):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ—É–¥–∞—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Dead Letter Queue"""
        dlq_data = {
            'original_message': msg.value().decode('utf-8') if msg.value() else None,
            'error': error,
            'partition': msg.partition(),
            'offset': msg.offset(),
            'timestamp': time.time(),
            'consumer_id': self.consumer_id,
        }
        
        # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ DLQ —Ç–æ–ø–∏–∫
        console.print(f"[magenta]üì≠ [{self.consumer_id}] –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ DLQ: offset {msg.offset()}[/magenta]")
        
        # –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
        with open(f"dlq_{self.consumer_id}.json", "a") as f:
            f.write(json.dumps(dlq_data) + "\n")
    
    def commit_offsets(self, force=False):
        """
        –†—É—á–Ω–æ–π –∫–æ–º–º–∏—Ç offset'–æ–≤
        
        Args:
            force: –∫–æ–º–º–∏—Ç–∏—Ç—å –≤—Å–µ pending offsets, –¥–∞–∂–µ –µ—Å–ª–∏ –∏—Ö –º–∞–ª–æ
        """
        with self.lock:
            if not self.pending_offsets:
                return
            
            offsets_to_commit = []
            total_messages = 0
            
            # –°–æ–±–∏—Ä–∞–µ–º offsets –¥–ª—è –∫–æ–º–º–∏—Ç–∞
            for partition, offsets in self.pending_offsets.items():
                if not offsets:
                    continue
                
                # –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π offset –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏
                max_offset = max(offsets.keys())
                offsets_to_commit.append(
                    TopicPartition(self.topic, partition, max_offset + 1)
                )
                
                total_messages += len(offsets)
            
            # –ö–æ–º–º–∏—Ç–∏–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞–∫–æ–ø–∏–ª–æ—Å—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–ª–∏ force=True
            if force or total_messages >= 10:  # –ö–æ–º–º–∏—Ç–∏–º –∫–∞–∂–¥—ã–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
                try:
                    self.consumer.commit(offsets=offsets_to_commit, asynchronous=False)
                    
                    console.print(f"\n[green]üíæ [{self.consumer_id}] –ó–∞–∫–æ–º–º–∏—á–µ–Ω—ã offsets:[/green]")
                    for tp in offsets_to_commit:
                        console.print(f"  Partition {tp.partition} -> offset {tp.offset}")
                        self.committed_offsets[tp.partition] = tp.offset
                    
                    self.stats['commits_successful'] += 1
                    self.stats['messages_committed'] += total_messages
                    
                    # –û—á–∏—â–∞–µ–º pending offsets
                    self.pending_offsets.clear()
                    
                except Exception as e:
                    console.print(f"[red]‚ùå [{self.consumer_id}] –û—à–∏–±–∫–∞ –∫–æ–º–º–∏—Ç–∞: {e}[/red]")
                    self.stats['commits_failed'] += 1
    
    def periodic_commit(self):
        """–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–∏—Ç (–∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥)"""
        if self.running:
            self.commit_offsets()
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
            self.commit_timer = threading.Timer(10.0, self.periodic_commit)
            self.commit_timer.daemon = True
            self.commit_timer.start()
    
    def consume(self, max_messages=None):
        """
        –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è
        
        Args:
            max_messages: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
        """
        console.print(f"\n[bold green]üöÄ [{self.consumer_id}] –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Å—é–º–µ—Ä–∞ —Å —Ä—É—á–Ω—ã–º –∫–æ–º–º–∏—Ç–æ–º[/bold green]")
        console.print(f"üë• Group ID: {self.config['group.id']}")
        console.print(f"üì≠ –¢–æ–ø–∏–∫: {self.topic}")
        console.print(f"üîß –°—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: {self.config['partition.assignment.strategy']}")
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º callback'–∏
        self.consumer.subscribe(
            [self.topic],
            on_assign=self.on_assign,
            on_revoke=self.on_revoke,
            on_lost=self.on_lost
        )
        
        message_count = 0
        
        try:
            while self.running and (max_messages is None or message_count < max_messages):
                msg = self.consumer.poll(timeout=1.0)
                
                if msg is None:
                    continue
                
                if msg.error():
                    if msg.error().code() == KafkaError._PARTITION_EOF:
                        console.print(f"[yellow]üì≠ [{self.consumer_id}] –ö–æ–Ω–µ—Ü –ø–∞—Ä—Ç–∏—Ü–∏–∏ {msg.partition()}[/yellow]")
                    elif msg.error().code() == KafkaError._UNKNOWN_TOPIC_OR_PART:
                        console.print(f"[red]‚ùå [{self.consumer_id}] –¢–æ–ø–∏–∫ –∏–ª–∏ –ø–∞—Ä—Ç–∏—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã[/red]")
                        break
                    else:
                        console.print(f"[red]‚ùå [{self.consumer_id}] –û—à–∏–±–∫–∞ Kafka: {msg.error()}[/red]")
                    continue
                
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                if self.process_message_with_retry(msg):
                    message_count += 1
                    
                    # –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∫–æ–º–º–∏—Ç–∏–º (–∫–∞–∂–¥—ã–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π)
                    if message_count % 10 == 0:
                        self.commit_offsets()
                    
                    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥—ã–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π
                    if message_count % 50 == 0:
                        self.show_stats()
        
        except KeyboardInterrupt:
            console.print(f"\n[yellow]‚ö†Ô∏è  [{self.consumer_id}] –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º[/yellow]")
        except Exception as e:
            console.print(f"[red]‚ùå [{self.consumer_id}] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}[/red]")
        finally:
            self.close()
    
    def show_stats(self):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
        duration = time.time() - self.stats['start_time']
        
        table = Table(title=f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ {self.consumer_id}")
        table.add_column("–ú–µ—Ç—Ä–∏–∫–∞", style="cyan")
        table.add_column("–ó–Ω–∞—á–µ–Ω–∏–µ", style="green")
        
        table.add_row("–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π", str(self.stats['messages_processed']))
        table.add_row("–ó–∞–∫–æ–º–º–∏—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π", str(self.stats['messages_committed']))
        table.add_row("–ù–µ—É–¥–∞—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π", str(self.stats['messages_failed']))
        table.add_row("–£—Å–ø–µ—à–Ω—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤", str(self.stats['commits_successful']))
        table.add_row("–ù–µ—É–¥–∞—á–Ω—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤", str(self.stats['commits_failed']))
        table.add_row("–†–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–æ–∫", str(self.stats['rebalances']))
        table.add_row("–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã", f"{duration:.1f} —Å–µ–∫")
        
        if duration > 0:
            rate = self.stats['messages_processed'] / duration
            table.add_row("–°–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏", f"{rate:.2f} —Å–æ–æ–±—â/—Å–µ–∫")
        
        console.print(table)
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ pending offsets
        with self.lock:
            if self.pending_offsets:
                console.print(f"[yellow]üìã [{self.consumer_id}] –û–∂–∏–¥–∞—é—â–∏–µ –∫–æ–º–º–∏—Ç–∞: {sum(len(v) for v in self.pending_offsets.values())} —Å–æ–æ–±—â–µ–Ω–∏–π[/yellow]")
    
    def close(self):
        """–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ"""
        console.print(f"\n[yellow]üîí [{self.consumer_id}] –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...[/yellow]")
        
        # –ö–æ–º–º–∏—Ç–∏–º –≤—Å–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è offsets
        self.commit_offsets(force=True)
        
        # –û—Ç–º–µ–Ω—è–µ–º —Ç–∞–π–º–µ—Ä
        if self.commit_timer:
            self.commit_timer.cancel()
        
        # –í—ã–≤–æ–¥–∏–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        console.print(f"\n[bold green]üìà [{self.consumer_id}] –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:[/bold green]")
        self.show_stats()
        
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Å—é–º–µ—Ä
        self.consumer.close()
        console.print(f"[green]‚úÖ [{self.consumer_id}] –ö–æ–Ω—Å—é–º–µ—Ä –∑–∞–∫—Ä—ã—Ç[/green]")

if __name__ == "__main__":
    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    BOOTSTRAP_SERVERS = "localhost:9092"
    GROUP_ID = "manual-commit-group"
    TOPIC = "user-actions"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–æ–ø–∏–∫–∞
    if not check_topic_exists(TOPIC):
        console.print("[red]‚ùå –¢–æ–ø–∏–∫ 'user-actions' –Ω–µ –Ω–∞–π–¥–µ–Ω![/red]")
        console.print("[yellow]üìå –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –æ–∫—Ä—É–∂–µ–Ω–∏—è:[/yellow]")
        console.print("[yellow]   python3 setup_demo.py[/yellow]")
        sys.exit(1)
    
    # –ü–æ–ª—É—á–∞–µ–º ID –∫–æ–Ω—Å—é–º–µ—Ä–∞ –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
    import argparse
    parser = argparse.ArgumentParser(description='Kafka Consumer —Å —Ä—É—á–Ω—ã–º –∫–æ–º–º–∏—Ç–æ–º')
    parser.add_argument('--id', default='consumer-1', help='ID –∫–æ–Ω—Å—é–º–µ—Ä–∞')
    parser.add_argument('--messages', type=int, default=200, help='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏')
    args = parser.parse_args()
    
    # –°–æ–∑–¥–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Å—é–º–µ—Ä
    consumer = ManualCommitConsumer(BOOTSTRAP_SERVERS, GROUP_ID, TOPIC, args.id)
    consumer.consume(max_messages=args.messages)
EOF

echo "–ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Å—é–º–µ—Ä —Å —Ä—É—á–Ω—ã–º –∫–æ–º–º–∏—Ç–æ–º (–≤ –æ–¥–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)..."
python3 manual_commit_consumer.py --id consumer-1 --messages 50

# ============================================
# 3. –ú–ù–û–ì–û–ü–†–û–¶–ï–°–°–ù–´–ô –ö–û–ù–°–Æ–ú–ï–† (CONSUMER GROUP)
# ============================================

echo "–°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–Ω—Å—é–º–µ—Ä–æ–≤ –≤ –≥—Ä—É–ø–ø–µ..."

cat > consumer_group_demo.py << 'EOF'
#!/usr/bin/env python3
"""
–î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –†–ê–ë–û–¢–´ CONSUMER GROUP –° –ù–ï–°–ö–û–õ–¨–ö–ò–ú–ò –ö–û–ù–°–Æ–ú–ï–†–ê–ú–ò

–ß—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
1. –†–∞–±–æ—Ç—É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–Ω—Å—é–º–µ—Ä–æ–≤ –≤ –æ–¥–Ω–æ–π consumer group
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π –º–µ–∂–¥—É –∫–æ–Ω—Å—é–º–µ—Ä–∞–º–∏
3. –†–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–Ω—Å—é–º–µ—Ä–æ–≤
4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è consumer group —á–µ—Ä–µ–∑ Kafka CLI
5. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∫–æ–Ω—Å—é–º–µ—Ä–∞–º–∏

–ö–æ–Ω—Ü–µ–ø—Ü–∏–∏ Kafka:
- Consumer Groups –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π
- Rebalance Protocol (–ø—Ä–æ—Ç–æ–∫–æ–ª —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏)
- Partition assignment strategies
- –°–æ—Å—Ç–æ—è–Ω–∏—è consumer group (Stable, PreparingRebalance, etc.)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ lag (–æ—Ç—Å—Ç–∞–≤–∞–Ω–∏—è) –∫–æ–Ω—Å—é–º–µ—Ä–æ–≤

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- Kafka –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏–∏ –º–µ–∂–¥—É –∫–æ–Ω—Å—é–º–µ—Ä–∞–º–∏
- –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–Ω—Å—é–º–µ—Ä–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞
- –ö–∞–∂–¥–∞—è –ø–∞—Ä—Ç–∏—Ü–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∏–º –∫–æ–Ω—Å—é–º–µ—Ä–æ–º –≤ –≥—Ä—É–ø–ø–µ
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ

–ó–∞–ø—É—Å–∫:
python3 consumer_group_demo.py
(–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç 3 –¥–ª—è –∑–∞–ø—É—Å–∫–∞ 3 –∫–æ–Ω—Å—é–º–µ—Ä–æ–≤)

–†–µ–∑—É–ª—å—Ç–∞—Ç:
–ó–∞–ø—É—Å—Ç—è—Ç—Å—è 3 –∫–æ–Ω—Å—é–º–µ—Ä–∞, –≤—ã —É–≤–∏–¥–∏—Ç–µ –∫–∞–∫ –ø–∞—Ä—Ç–∏—Ü–∏–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –º–µ–∂–¥—É –Ω–∏–º–∏.
–ú–æ–∂–Ω–æ –Ω–∞–±–ª—é–¥–∞—Ç—å –∑–∞ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–æ–π –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ/–∑–∞–ø—É—Å–∫–µ –∫–æ–Ω—Å—é–º–µ—Ä–æ–≤.
"""

import subprocess
import threading
import time
import sys
import os
from rich.console import Console
from rich.table import Table
from rich.layout import Layout
from rich.live import Live
from rich.panel import Panel

console = Console()

def check_kafka_topic():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–æ–ø–∏–∫–∞"""
    print("üîç –ü—Ä–æ–≤–µ—Ä—è—é —Ç–æ–ø–∏–∫ 'user-actions'...")
    
    try:
        cmd = ['/opt/kafka/bin/kafka-topics.sh', '--describe', 
               '--bootstrap-server', 'localhost:9092', '--topic', 'user-actions']
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=5)
        
        if result.returncode != 0 or "Topic: user-actions" not in result.stdout:
            print("‚ùå –¢–æ–ø–∏–∫ 'user-actions' –Ω–µ –Ω–∞–π–¥–µ–Ω!")
            print("\nüìå –í–∞–º –Ω—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é:")
            print("   1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: python3 setup_demo.py")
            print("   2. –°–æ–∑–¥–∞–π—Ç–µ —Ç–æ–ø–∏–∫ –∏ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ")
            print("   3. –ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç—É –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é —Å–Ω–æ–≤–∞")
            return False
        
        print("‚úÖ –¢–æ–ø–∏–∫ 'user-actions' –Ω–∞–π–¥–µ–Ω")
        return True
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ: {e}")
        return False

def run_consumer(consumer_id, num_messages=100):
    """–ó–∞–ø—É—Å–∫ –∫–æ–Ω—Å—é–º–µ—Ä–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ"""
    cmd = [
        sys.executable, 'manual_commit_consumer.py',
        '--id', consumer_id,
        '--messages', str(num_messages)
    ]
    
    console.print(f"\n[bold green]üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Å—é–º–µ—Ä–∞ {consumer_id}[/bold green]")
    
    process = subprocess.Popen(
        cmd,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True,
        bufsize=1,
        universal_newlines=True
    )
    
    # –ß–∏—Ç–∞–µ–º –≤—ã–≤–æ–¥ –≤ —Ñ–æ–Ω–µ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    def read_output(pipe, consumer_id):
        for line in pipe:
            if line.strip():
                console.print(f"[dim][{consumer_id}][/dim] {line.strip()}")
    
    threading.Thread(target=read_output, args=(process.stdout, consumer_id), daemon=True).start()
    threading.Thread(target=read_output, args=(process.stderr, consumer_id), daemon=True).start()
    
    return process

def monitor_consumers(processes):
    """–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö –∫–æ–Ω—Å—é–º–µ—Ä–æ–≤"""
    console.print("\n[bold cyan]üëÅÔ∏è  –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–Ω—Å—é–º–µ—Ä–æ–≤... (Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏)[/bold cyan]")
    console.print("[yellow]‚ÑπÔ∏è  –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: python3 rebalance_test.py –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏[/yellow]")
    
    try:
        start_time = time.time()
        
        # –ü—Ä–æ—Å—Ç–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑ rich.live
        while True:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
            console.print("\n" + "="*60)
            console.print(f"[bold]–°—Ç–∞—Ç—É—Å –∫–æ–Ω—Å—é–º–µ—Ä–æ–≤ (–≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: {time.time() - start_time:.1f} —Å–µ–∫)[/bold]")
            
            all_running = True
            for consumer_id, process in processes.items():
                returncode = process.poll()
                if returncode is None:
                    status = "üü¢ –†–∞–±–æ—Ç–∞–µ—Ç"
                else:
                    status = f"üî¥ –ó–∞–≤–µ—Ä—à–µ–Ω (–∫–æ–¥: {returncode})"
                    all_running = False
                console.print(f"  {consumer_id}: {status}")
            
            if not all_running:
                console.print("\n[yellow]‚ö†Ô∏è  –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–Ω—Å—é–º–µ—Ä—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å[/yellow]")
                break
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º consumer group —á–µ—Ä–µ–∑ Kafka
            console.print("\n[bold]–ü—Ä–æ–≤–µ—Ä–∫–∞ consumer group —á–µ—Ä–µ–∑ Kafka:[/bold]")
            try:
                result = subprocess.run(
                    ['/opt/kafka/bin/kafka-consumer-groups.sh',
                     '--bootstrap-server', 'localhost:9092',
                     '--group', 'manual-commit-group',
                     '--describe'],
                    capture_output=True,
                    text=True,
                    timeout=5
                )
                
                if result.returncode == 0:
                    lines = result.stdout.strip().split('\n')
                    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫
                    for line in lines[:5]:
                        console.print(f"  {line}")
                    if len(lines) > 5:
                        console.print(f"  ... –∏ –µ—â—ë {len(lines) - 5} —Å—Ç—Ä–æ–∫")
                else:
                    console.print(f"  [yellow]–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é: {result.stderr}[/yellow]")
                    
            except Exception as e:
                console.print(f"  [yellow]–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ: {e}[/yellow]")
            
            # –ñ–¥–µ–º 5 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
            time.sleep(5)
            
    except KeyboardInterrupt:
        console.print("\n[yellow]‚ö†Ô∏è  –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–µ—Ä–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º[/yellow]")
    
    finally:
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
        console.print("\n[yellow]üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Å—é–º–µ—Ä—ã...[/yellow]")
        for consumer_id, process in processes.items():
            if process.poll() is None:  # –ï—Å–ª–∏ –µ—â—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
                process.terminate()
                try:
                    process.wait(timeout=5)
                    console.print(f"  ‚úÖ {consumer_id}: –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
                except subprocess.TimeoutExpired:
                    process.kill()
                    console.print(f"  üî¥ {consumer_id}: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω")

def check_consumer_group():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ consumer group —á–µ—Ä–µ–∑ Kafka CLI"""
    console.print("\n[bold cyan]üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ consumer group —á–µ—Ä–µ–∑ Kafka...[/bold cyan]")
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ consumer groups
        result = subprocess.run(
            ['/opt/kafka/bin/kafka-consumer-groups.sh',
             '--bootstrap-server', 'localhost:9092',
             '--list'],
            capture_output=True,
            text=True,
            timeout=5
        )
        
        console.print("[bold]–ù–∞–π–¥–µ–Ω–Ω—ã–µ consumer groups:[/bold]")
        for line in result.stdout.strip().split('\n'):
            if line.strip():
                console.print(f"  {line}")
        
        if 'manual-commit-group' in result.stdout:
            console.print("\n[green]‚úÖ Consumer group 'manual-commit-group' –Ω–∞–π–¥–µ–Ω[/green]")
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            result = subprocess.run(
                ['/opt/kafka/bin/kafka-consumer-groups.sh',
                 '--bootstrap-server', 'localhost:9092',
                 '--group', 'manual-commit-group',
                 '--describe'],
                capture_output=True,
                text=True,
                timeout=5
            )
            
            console.print("\n[bold]–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ consumer group:[/bold]")
            for line in result.stdout.split('\n'):
                if line.strip():
                    console.print(f"  {line}")
        else:
            console.print("\n[yellow]‚ö†Ô∏è  Consumer group 'manual-commit-group' –Ω–µ –Ω–∞–π–¥–µ–Ω (–≤–æ–∑–º–æ–∂–Ω–æ, –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω)[/yellow]")
            
    except Exception as e:
        console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ consumer group: {e}[/red]")

def simple_consumer_group_demo():
    """–ü—Ä–æ—Å—Ç–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã consumer group"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ø–∏–∫
    if not check_kafka_topic():
        return
    
    console.print("\n[bold magenta]üîÑ –ü–†–û–°–¢–ê–Ø –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø CONSUMER GROUP[/bold magenta]")
    console.print("1. –ó–∞–ø—É—Å–∫–∞–µ–º 3 –∫–æ–Ω—Å—é–º–µ—Ä–∞ –≤ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø–µ")
    console.print("2. –ö–∞–∂–¥–æ–º—É –Ω–∞–∑–Ω–∞—á–∞—Ç—Å—è –ø–æ 2 –ø–∞—Ä—Ç–∏—Ü–∏–∏ (–≤—Å–µ–≥–æ 6 –ø–∞—Ä—Ç–∏—Ü–∏–π –≤ —Ç–æ–ø–∏–∫–µ 'user-actions')")
    console.print("3. –ù–∞–±–ª—é–¥–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π")
    console.print("4. –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª")
    console.print("5. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: python3 rebalance_test.py")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º 3 –∫–æ–Ω—Å—é–º–µ—Ä–∞
    processes = {}
    for i in range(1, 4):
        consumer_id = f"consumer-{i}"
        processes[consumer_id] = run_consumer(consumer_id, num_messages=300)
    
    # –î–∞–µ–º –∏–º –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å 5 —Å–µ–∫—É–Ω–¥
    console.print("\n[yellow]‚è≥ –ö–æ–Ω—Å—é–º–µ—Ä—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è (5 —Å–µ–∫—É–Ω–¥)...[/yellow]")
    time.sleep(5)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥—Ä—É–ø–ø—ã
    check_consumer_group()
    
    # –ú–æ–Ω–∏—Ç–æ—Ä–∏–º –∏—Ö —Ä–∞–±–æ—Ç—É
    console.print("\n[yellow]üìä –ù–∞—á–∏–Ω–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–Ω–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏)...[/yellow]")
    monitor_consumers(processes)
    
    console.print("\n[bold green]‚úÖ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è consumer group –∑–∞–≤–µ—Ä—à–µ–Ω–∞![/bold green]")

if __name__ == "__main__":
    console.print("[bold blue]=" * 60)
    console.print("         –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø CONSUMER GROUP –ò –†–ï–ë–ê–õ–ê–ù–°–ò–†–û–í–ö–ò")
    console.print("=" * 60)
    
    # –í–∞—Ä–∏–∞–Ω—Ç—ã –∑–∞–ø—É—Å–∫–∞
    console.print("\n[bold]–í–∞—Ä–∏–∞–Ω—Ç—ã –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏:[/bold]")
    console.print("  1. –ó–∞–ø—É—Å—Ç–∏—Ç—å 3 –∫–æ–Ω—Å—é–º–µ—Ä–∞ –∏ –Ω–∞–±–ª—é–¥–∞—Ç—å –∑–∞ –Ω–∏–º–∏")
    console.print("  2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ consumer group")
    console.print("  3. –ü—Ä–æ—Å—Ç–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)")
    
    try:
        choice = input("\n–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç (1-3): ").strip()
        
        if choice == '1':
            # –ó–∞–ø—É—Å–∫–∞–µ–º 3 –∫–æ–Ω—Å—é–º–µ—Ä–∞
            processes = {}
            for i in range(1, 4):
                consumer_id = f"group-consumer-{i}"
                processes[consumer_id] = run_consumer(consumer_id, num_messages=300)
            
            # –ú–æ–Ω–∏—Ç–æ—Ä–∏–º –∏—Ö —Ä–∞–±–æ—Ç—É
            monitor_consumers(processes)
            
        elif choice == '2':
            # –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º consumer group
            check_consumer_group()
            
        elif choice == '3':
            # –ü—Ä–æ—Å—Ç–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è
            simple_consumer_group_demo()
            
        else:
            console.print("[red]‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä[/red]")
    
    except KeyboardInterrupt:
        console.print("\n[yellow]‚ö†Ô∏è  –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º[/yellow]")
    
    console.print("\n[bold green]üéâ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞![/bold green]")
    console.print("\n[yellow]üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:[/yellow]")
    console.print("  - –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: python3 rebalance_test.py")
    console.print("  - –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: python3 error_handling_consumer.py")
    console.print("  - –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª—ã: dlq_*.json –∏ consumer_stats.json")
EOF

echo "–ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é consumer group..."
echo "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç 3 –¥–ª—è –∑–∞–ø—É—Å–∫–∞ 3 –∫–æ–Ω—Å—é–º–µ—Ä–æ–≤"
python3 consumer_group_demo.py

# ============================================
# 4. –ö–û–ù–°–Æ–ú–ï–† –° –ü–†–û–î–í–ò–ù–£–¢–û–ô –û–ë–†–ê–ë–û–¢–ö–û–ô –û–®–ò–ë–û–ö
# ============================================

echo "–°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Å—é–º–µ—Ä —Å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫..."

cat > error_handling_consumer.py << 'EOF'
#!/usr/bin/env python3
"""
–ö–û–ù–°–Æ–ú–ï–† –° –ü–†–û–î–í–ò–ù–£–¢–û–ô –û–ë–†–ê–ë–û–¢–ö–û–ô –û–®–ò–ë–û–ö –ò –†–ï–ó–ï–†–í–ù–´–ú–ò –°–¢–†–ê–¢–ï–ì–ò–Ø–ú–ò

–ß—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
1. Circuit Breaker –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤
2. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π (idempotent consumer)
3. Retry –ª–æ–≥–∏–∫—É —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
4. Dead Letter Queue (DLQ) —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–æ–ø–∏–∫
5. –í–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
6. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏
7. –ì–µ–Ω–µ—Ä–∞—Ü–∏—é —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å –ø—Ä–µ–¥–Ω–∞–º–µ—Ä–µ–Ω–Ω—ã–º–∏ –æ—à–∏–±–∫–∞–º–∏

–ö–æ–Ω—Ü–µ–ø—Ü–∏–∏ Kafka:
- Production-ready –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –ò–∑–æ–ª—è—Ü–∏—è —Å–±–æ–µ–≤ (Circuit Breaker)
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏
- Dead Letter Queues –¥–ª—è –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ö–µ–º—ã —Å–æ–æ–±—â–µ–Ω–∏–π

–ü–∞—Ç—Ç–µ—Ä–Ω—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫:
1. Circuit Breaker: –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö –æ—à–∏–±–∫–∞—Ö
2. Retry with backoff: –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ–º –∑–∞–¥–µ—Ä–∂–∫–∏
3. Dead Letter Queue: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ—É–¥–∞—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
4. Validation: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
5. Deduplication: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

–ó–∞–ø—É—Å–∫:
python3 error_handling_consumer.py --produce --messages 30

–†–µ–∑—É–ª—å—Ç–∞—Ç:
–ë—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–≤–∫–ª—é—á–∞—è "–ø–ª–æ—Ö–∏–µ"),
–æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –≤—Å–µ—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫,
—Å–æ–∑–¥–∞–Ω DLQ —Ç–æ–ø–∏–∫ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ñ–∞–π–ª.
"""

from confluent_kafka import Consumer, KafkaError, Producer
import json
import time
import signal
import sys
import threading
from enum import Enum
from dataclasses import dataclass
from typing import Optional, Dict, Any
from rich.console import Console
from rich.table import Table
from rich.panel import Panel
import hashlib
import subprocess
import argparse

console = Console()

def check_topic_exists(topic="user-actions"):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–æ–ø–∏–∫–∞"""
    try:
        cmd = ['/opt/kafka/bin/kafka-topics.sh', '--describe', 
               '--bootstrap-server', 'localhost:9092', '--topic', topic]
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=5)
        
        if result.returncode != 0 or f"Topic: {topic}" not in result.stdout:
            return False
        return True
    except Exception:
        return False

class ProcessingResult(Enum):
    """–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    SUCCESS = "success"
    RETRY = "retry"
    DLQ = "dlq"  # Dead Letter Queue
    SKIP = "skip"
    FATAL = "fatal"

@dataclass
class ProcessedMessage:
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏"""
    partition: int
    offset: int
    result: ProcessingResult
    processing_time: float
    error: Optional[str] = None
    retry_count: int = 0

class TestMessageProducer:
    """–ü—Ä–æ–¥—é—Å–µ—Ä —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    def __init__(self, topic="user-actions", bootstrap_servers="localhost:9092"):
        self.producer = Producer({'bootstrap.servers': bootstrap_servers})
        self.topic = topic
        self.message_count = 0
    
    def produce_messages(self, num_messages=100):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
        console.print(f"[cyan]üì® –ì–µ–Ω–µ—Ä–∏—Ä—É—é {num_messages} —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π...[/cyan]")
        
        for i in range(num_messages):
            message = {
                'event_id': f'error-test-{int(time.time())}-{i}',
                'user_id': f'user_{i % 50}',
                'action': ['login', 'logout', 'purchase', 'view', 'search', 'click', 'add_to_cart'][i % 7],
                'timestamp': time.time() * 1000,
                'data': {
                    'page': f'/page/{i % 10}',
                    'amount': round(i * 1.5, 2) if i % 3 == 0 else None,
                    'test_type': 'error_handling_demo'
                }
            }
            
            # –ù–∞–º–µ—Ä–µ–Ω–Ω–æ —Å–æ–∑–¥–∞–µ–º 10% "–ø–ª–æ—Ö–∏—Ö" —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
            if i % 10 == 0:
                message['action'] = 'invalid_action'  # –ù–µ–≤–∞–ª–∏–¥–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
            elif i % 13 == 0:
                message.pop('user_id')  # –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ
            elif i % 17 == 0:
                message['timestamp'] = 'invalid_timestamp'  # –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π timestamp
            
            self.producer.produce(
                self.topic,
                key=str(i % 6),
                value=json.dumps(message, ensure_ascii=False),
                callback=self.delivery_callback
            )
            self.producer.poll(0)
        
        self.producer.flush()
        console.print(f"[green]‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ {self.message_count} —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π[/green]")
    
    def delivery_callback(self, err, msg):
        if err:
            console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏: {err}[/red]")
        else:
            self.message_count += 1
            if self.message_count % 20 == 0:
                console.print(f"[cyan]üì® –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {self.message_count} —Å–æ–æ–±—â–µ–Ω–∏–π...[/cyan]")

class ErrorHandlingConsumer:
    def __init__(self, bootstrap_servers, group_id, topic, produce_test_messages=False):
        """
        –ö–æ–Ω—Å—é–º–µ—Ä —Å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        
        Args:
            bootstrap_servers: –∞–¥—Ä–µ—Å–∞ –±—Ä–æ–∫–µ—Ä–æ–≤
            group_id: ID –≥—Ä—É–ø–ø—ã
            topic: —Ç–æ–ø–∏–∫ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏
            produce_test_messages: —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        """
        self.config = {
            'bootstrap.servers': bootstrap_servers,
            'group.id': group_id,
            'auto.offset.reset': 'earliest',  # –ß–∏—Ç–∞–µ–º —Å –Ω–∞—á–∞–ª–∞
            'enable.auto.commit': False,
            'session.timeout.ms': 10000,
            'max.poll.interval.ms': 300000,
            'isolation.level': 'read_committed',
        }
        
        self.consumer = Consumer(self.config)
        self.topic = topic
        self.running = True
        
        # Producer –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ DLQ
        self.dlq_producer = Producer({
            'bootstrap.servers': bootstrap_servers,
            'acks': 'all',
        })
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
        self.stats = {
            'total_messages': 0,
            'success': 0,
            'retries': 0,
            'dlq': 0,
            'skipped': 0,
            'fatal': 0,
            'processing_time': 0,
            'errors_by_type': {},
            'start_time': time.time(),
        }
        
        # –û—á–µ—Ä–µ–¥—å –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
        self.retry_queue = []
        self.retry_lock = threading.Lock()
        
        # Circuit Breaker —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        self.circuit_state = {
            'open': False,
            'failure_count': 0,
            'last_failure': 0,
            'half_open_time': 0,
        }
        
        # –•—ç—à-—Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
        self.processed_messages = set()
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤
        signal.signal(signal.SIGINT, self.signal_handler)
        signal.signal(signal.SIGTERM, self.signal_handler)
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–µ –ø–æ—Ç–æ–∫–∏
        self.retry_thread = threading.Thread(target=self.process_retry_queue, daemon=True)
        self.retry_thread.start()
        
        self.monitor_thread = threading.Thread(target=self.monitor_health, daemon=True)
        self.monitor_thread.start()
        
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if produce_test_messages:
            producer = TestMessageProducer(topic, bootstrap_servers)
            producer.produce_messages(50)
    
    def signal_handler(self, signum, frame):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤"""
        console.print(f"\n[yellow]‚ö†Ô∏è  –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª {signum}, graceful shutdown...[/yellow]")
        self.running = False
    
    def message_hash(self, msg):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ö—ç—à–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏"""
        content = f"{msg.partition()}:{msg.offset()}:{msg.value()}"
        return hashlib.md5(content.encode()).hexdigest()
    
    def check_circuit_breaker(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è Circuit Breaker"""
        if self.circuit_state['open']:
            # –ï—Å–ª–∏ Circuit Breaker –æ—Ç–∫—Ä—ã—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–π—Ç–∏ –≤ half-open
            if time.time() - self.circuit_state['last_failure'] > 30:  # 30 —Å–µ–∫—É–Ω–¥
                self.circuit_state['open'] = False
                self.circuit_state['half_open_time'] = time.time()
                console.print("[yellow]üîÑ Circuit Breaker –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ half-open —Å–æ—Å—Ç–æ—è–Ω–∏–µ[/yellow]")
                return True
            return False
        
        # –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫, –æ—Ç–∫—Ä—ã–≤–∞–µ–º Circuit Breaker
        if self.circuit_state['failure_count'] >= 10:
            self.circuit_state['open'] = True
            self.circuit_state['last_failure'] = time.time()
            console.print("[red]üî¥ Circuit Breaker –æ—Ç–∫—Ä—ã—Ç! –ü–∞—É–∑–∞ 30 —Å–µ–∫—É–Ω–¥[/red]")
            return False
        
        return True
    
    def record_failure(self, error_type):
        """–ó–∞–ø–∏—Å—å –æ—à–∏–±–∫–∏ –¥–ª—è Circuit Breaker"""
        self.circuit_state['failure_count'] += 1
        
        if error_type not in self.stats['errors_by_type']:
            self.stats['errors_by_type'][error_type] = 0
        self.stats['errors_by_type'][error_type] += 1
    
    def record_success(self):
        """–ó–∞–ø–∏—Å—å —É—Å–ø–µ—Ö–∞ –¥–ª—è Circuit Breaker"""
        if self.circuit_state['failure_count'] > 0:
            self.circuit_state['failure_count'] -= 1
    
    def validate_message(self, data):
        """–í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è"""
        required_fields = ['event_id', 'user_id', 'action', 'timestamp']
        
        for field in required_fields:
            if field not in data:
                return False, f"Missing required field: {field}"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ timestamp
        try:
            # –ü—Ä–æ–±—É–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å timestamp
            ts = float(data['timestamp'])
            if ts <= 0:
                return False, "Invalid timestamp value"
        except (ValueError, TypeError):
            return False, "Invalid timestamp format"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ action
        valid_actions = ['login', 'logout', 'purchase', 'view', 'search', 'click', 'add_to_cart']
        if data['action'] not in valid_actions:
            return False, f"Invalid action: {data['action']}"
        
        return True, "OK"
    
    def business_logic(self, data):
        """–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        # –ò–º–∏—Ç–∞—Ü–∏—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        
        # 1. –ü–æ–∫—É–ø–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–æ–ª–≥–æ
        if data['action'] == 'purchase':
            time.sleep(0.1)  # 100ms
            if 'data' not in data or 'amount' not in data['data']:
                raise ValueError("Purchase missing amount")
        
        # 2. –õ–æ–≥–∏–Ω—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —á–∞—Å—Ç–æ—Ç—É
        elif data['action'] == 'login':
            time.sleep(0.05)  # 50ms
        
        # 3. 10% —Å–æ–æ–±—â–µ–Ω–∏–π –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –æ—à–∏–±–∫—É –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
        elif hash(data.get('event_id', '')) % 100 < 10:
            raise Exception("Random processing error (10% chance)")
        
        # 4. –û–±—ã—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
        else:
            time.sleep(0.02)  # 20ms
        
        return True
    
    def process_message(self, msg) -> ProcessedMessage:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–ª–Ω—ã–º —Ü–∏–∫–ª–æ–º error handling
        
        Args:
            msg: —Å–æ–æ–±—â–µ–Ω–∏–µ Kafka
        
        Returns:
            ProcessedMessage: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
        """
        start_time = time.time()
        
        if msg.value() is None:
            console.print(f"[yellow]‚ö†Ô∏è  –ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º[/yellow]")
            return ProcessedMessage(
                partition=msg.partition(),
                offset=msg.offset(),
                result=ProcessingResult.SKIP,
                processing_time=time.time() - start_time
            )
        
        msg_hash = self.message_hash(msg)
        
        # –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
        if msg_hash in self.processed_messages:
            console.print(f"[yellow]‚ö†Ô∏è  –î—É–±–ª–∏–∫–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º[/yellow]")
            return ProcessedMessage(
                partition=msg.partition(),
                offset=msg.offset(),
                result=ProcessingResult.SKIP,
                processing_time=time.time() - start_time
            )
        
        try:
            # –®–∞–≥ 2: –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
            value = msg.value().decode('utf-8')
            data = json.loads(value)
            
            # –®–∞–≥ 3: –í–∞–ª–∏–¥–∞—Ü–∏—è
            is_valid, validation_error = self.validate_message(data)
            if not is_valid:
                console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: {validation_error}[/red]")
                console.print(f"[dim]   –î–∞–Ω–Ω—ã–µ: {json.dumps(data, ensure_ascii=False)[:100]}...[/dim]")
                self.record_failure("validation")
                return ProcessedMessage(
                    partition=msg.partition(),
                    offset=msg.offset(),
                    result=ProcessingResult.DLQ,
                    processing_time=time.time() - start_time,
                    error=validation_error
                )
            
            # –®–∞–≥ 4: –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
            self.business_logic(data)
            
            # –®–∞–≥ 5: –£—Å–ø–µ—à–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
            self.processed_messages.add(msg_hash)
            self.record_success()
            
            console.print(f"[green]‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {data.get('action', 'N/A')} (user: {data.get('user_id', 'N/A')[:8]}...)[/green]")
            
            return ProcessedMessage(
                partition=msg.partition(),
                offset=msg.offset(),
                result=ProcessingResult.SUCCESS,
                processing_time=time.time() - start_time
            )
            
        except json.JSONDecodeError as e:
            error_msg = f"JSON decode error: {e}"
            console.print(f"[red]‚ùå {error_msg}[/red]")
            self.record_failure("json_decode")
            return ProcessedMessage(
                partition=msg.partition(),
                offset=msg.offset(),
                result=ProcessingResult.DLQ,
                processing_time=time.time() - start_time,
                error=error_msg
            )
            
        except KeyError as e:
            error_msg = f"Missing key: {e}"
            console.print(f"[red]‚ùå {error_msg}[/red]")
            self.record_failure("missing_key")
            return ProcessedMessage(
                partition=msg.partition(),
                offset=msg.offset(),
                result=ProcessingResult.RETRY,
                processing_time=time.time() - start_time,
                error=error_msg,
                retry_count=1
            )
            
        except ValueError as e:
            error_msg = f"Value error: {e}"
            console.print(f"[red]‚ùå {error_msg}[/red]")
            self.record_failure("value_error")
            return ProcessedMessage(
                partition=msg.partition(),
                offset=msg.offset(),
                result=ProcessingResult.DLQ,
                processing_time=time.time() - start_time,
                error=error_msg
            )
            
        except Exception as e:
            error_msg = f"Processing error: {e}"
            console.print(f"[red]‚ùå {error_msg}[/red]")
            self.record_failure("processing")
            
            # –î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –æ—à–∏–±–æ–∫ –ø—Ä–æ–±—É–µ–º retry
            if "temporary" in str(e).lower() or "timeout" in str(e).lower():
                return ProcessedMessage(
                    partition=msg.partition(),
                    offset=msg.offset(),
                    result=ProcessingResult.RETRY,
                    processing_time=time.time() - start_time,
                    error=error_msg,
                    retry_count=1
                )
            else:
                return ProcessedMessage(
                    partition=msg.partition(),
                    offset=msg.offset(),
                    result=ProcessingResult.DLQ,
                    processing_time=time.time() - start_time,
                    error=error_msg
                )
    
    def send_to_dlq(self, msg, error):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Dead Letter Queue"""
        dlq_message = {
            'original_message': msg.value().decode('utf-8') if msg.value() else None,
            'error': error,
            'original_topic': self.topic,
            'original_partition': msg.partition(),
            'original_offset': msg.offset(),
            'timestamp': time.time(),
            'dlq_topic': f"{self.topic}-dlq",
        }
        
        try:
            self.dlq_producer.produce(
                topic=f"{self.topic}-dlq",
                key=msg.key(),
                value=json.dumps(dlq_message),
                callback=lambda err, m: None
            )
            self.dlq_producer.poll(0)
            return True
        except Exception as e:
            console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ DLQ: {e}[/red]")
            return False
    
    def add_to_retry_queue(self, msg, processed_msg):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏"""
        with self.retry_lock:
            self.retry_queue.append({
                'msg': msg,
                'processed_msg': processed_msg,
                'added_at': time.time(),
                'attempt': processed_msg.retry_count,
            })
            console.print(f"[yellow]üîÑ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ retry –æ—á–µ—Ä–µ–¥—å (–ø–æ–ø—ã—Ç–∫–∞ {processed_msg.retry_count + 1})[/yellow]")
    
    def process_retry_queue(self):
        """–§–æ–Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ retry –æ—á–µ—Ä–µ–¥–∏"""
        console.print("[cyan]üîÑ –ó–∞–ø—É—â–µ–Ω –ø–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ retry –æ—á–µ—Ä–µ–¥–∏[/cyan]")
        
        while self.running:
            time.sleep(2)  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
            
            with self.retry_lock:
                current_time = time.time()
                to_process = []
                remaining = []
                
                for item in self.retry_queue:
                    # –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 2^attempt —Å–µ–∫—É–Ω–¥
                    delay = 2 ** item['attempt']
                    
                    if current_time - item['added_at'] >= delay:
                        to_process.append(item)
                    else:
                        remaining.append(item)
                
                self.retry_queue = remaining
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ retry –æ—á–µ—Ä–µ–¥–∏
            for item in to_process:
                console.print(f"[yellow]üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–ø–æ–ø—ã—Ç–∫–∞ {item['attempt'] + 1})[/yellow]")
                
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–Ω–æ–≤–∞
                processed_msg = self.process_message(item['msg'])
                
                if processed_msg.result == ProcessingResult.RETRY:
                    # –ï—Å–ª–∏ —Å–Ω–æ–≤–∞ –Ω—É–∂–Ω–æ retry, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                    item['attempt'] += 1
                    item['added_at'] = time.time()
                    
                    if item['attempt'] < 3:  # –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏
                        with self.retry_lock:
                            self.retry_queue.append(item)
                    else:
                        console.print(f"[red]‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ retry, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ DLQ[/red]")
                        self.send_to_dlq(item['msg'], f"Max retries exceeded: {processed_msg.error}")
                elif processed_msg.result == ProcessingResult.DLQ:
                    self.send_to_dlq(item['msg'], processed_msg.error)
    
    def monitor_health(self):
        """–§–æ–Ω–æ–≤—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è –∫–æ–Ω—Å—é–º–µ—Ä–∞"""
        while self.running:
            time.sleep(5)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º Circuit Breaker
            if not self.check_circuit_breaker():
                console.print("[red]üî¥ Circuit Breaker –æ—Ç–∫—Ä—ã—Ç, –ø–∞—É–∑–∞ 1 —Å–µ–∫—É–Ω–¥–∞[/red]")
                time.sleep(1)
            
            # –í—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            if int(time.time()) % 30 == 0:
                self.show_stats()
    
    def update_stats(self, processed_msg):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        self.stats['total_messages'] += 1
        self.stats['processing_time'] += processed_msg.processing_time
        
        if processed_msg.result == ProcessingResult.SUCCESS:
            self.stats['success'] += 1
        elif processed_msg.result == ProcessingResult.RETRY:
            self.stats['retries'] += 1
        elif processed_msg.result == ProcessingResult.DLQ:
            self.stats['dlq'] += 1
        elif processed_msg.result == ProcessingResult.SKIP:
            self.stats['skipped'] += 1
        elif processed_msg.result == ProcessingResult.FATAL:
            self.stats['fatal'] += 1
    
    def show_stats(self):
        """–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        duration = time.time() - self.stats['start_time']
        
        table = Table(title="üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò –û–®–ò–ë–û–ö", width=80)
        table.add_column("–ú–µ—Ç—Ä–∏–∫–∞", style="cyan", width=30)
        table.add_column("–ó–Ω–∞—á–µ–Ω–∏–µ", style="green", width=50)
        
        table.add_row("–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π", str(self.stats['total_messages']))
        table.add_row("–£—Å–ø–µ—à–Ω–æ", str(self.stats['success']))
        table.add_row("Retry", str(self.stats['retries']))
        table.add_row("DLQ", str(self.stats['dlq']))
        table.add_row("–ü—Ä–æ–ø—É—â–µ–Ω–æ", str(self.stats['skipped']))
        table.add_row("–§–∞—Ç–∞–ª—å–Ω—ã—Ö", str(self.stats['fatal']))
        
        if self.stats['total_messages'] > 0:
            success_rate = (self.stats['success'] / self.stats['total_messages']) * 100
            avg_time = self.stats['processing_time'] / self.stats['total_messages'] * 1000
            
            table.add_row("–£—Å–ø–µ—à–Ω–æ—Å—Ç—å", f"{success_rate:.1f}%")
            table.add_row("–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è", f"{avg_time:.2f} –º—Å")
        
        table.add_row("–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã", f"{duration:.1f} —Å–µ–∫")
        
        # Circuit Breaker —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        cb_status = "üî¥ OPEN" if self.circuit_state['open'] else "üü¢ CLOSED"
        table.add_row("Circuit Breaker", cb_status)
        
        # –û—à–∏–±–∫–∏ –ø–æ —Ç–∏–ø–∞–º
        if self.stats['errors_by_type']:
            table.add_row("–û—à–∏–±–∫–∏ –ø–æ —Ç–∏–ø–∞–º", ", ".join([f"{k}:{v}" for k, v in self.stats['errors_by_type'].items()]))
        
        console.print(table)
        
        # Retry –æ—á–µ—Ä–µ–¥—å
        with self.retry_lock:
            if self.retry_queue:
                console.print(f"[yellow]üìã –í retry –æ—á–µ—Ä–µ–¥–∏: {len(self.retry_queue)} —Å–æ–æ–±—â–µ–Ω–∏–π[/yellow]")
    
    def consume(self, max_messages=None):
        """
        –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è
        
        Args:
            max_messages: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
        """
        console.print(Panel.fit(
            "[bold green]üöÄ –ó–ê–ü–£–°–ö –ö–û–ù–°–Æ–ú–ï–†–ê –° –ü–†–û–î–í–ò–ù–£–¢–û–ô –û–ë–†–ê–ë–û–¢–ö–û–ô –û–®–ò–ë–û–ö[/bold green]\n"
            f"üë• Group ID: {self.config['group.id']}\n"
            f"üì≠ –¢–æ–ø–∏–∫: {self.topic}\n"
            f"üõ°Ô∏è  –°—Ç—Ä–∞—Ç–µ–≥–∏–∏: Circuit Breaker, Retry, DLQ, –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è",
            border_style="green"
        ))
        
        # –°–æ–∑–¥–∞–µ–º DLQ —Ç–æ–ø–∏–∫ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        self.create_dlq_topic()
        
        self.consumer.subscribe([self.topic])
        
        message_count = 0
        
        try:
            while self.running and (max_messages is None or message_count < max_messages):
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º Circuit Breaker
                if not self.check_circuit_breaker():
                    time.sleep(1)
                    continue
                
                # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                msg = self.consumer.poll(timeout=2.0)
                
                if msg is None:
                    continue
                
                if msg.error():
                    if msg.error().code() == KafkaError._PARTITION_EOF:
                        continue
                    else:
                        console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ Kafka: {msg.error()}[/red]")
                        self.record_failure("kafka")
                        continue
                
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                processed_msg = self.process_message(msg)
                self.update_stats(processed_msg)
                
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                if processed_msg.result == ProcessingResult.SUCCESS:
                    # –ö–æ–º–º–∏—Ç–∏–º offset
                    self.consumer.commit(message=msg, asynchronous=False)
                    message_count += 1
                    
                elif processed_msg.result == ProcessingResult.RETRY:
                    self.add_to_retry_queue(msg, processed_msg)
                    
                elif processed_msg.result == ProcessingResult.DLQ:
                    self.send_to_dlq(msg, processed_msg.error)
                    # –ö–æ–º–º–∏—Ç–∏–º offset —Ç.–∫. –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –≤ DLQ
                    self.consumer.commit(message=msg, asynchronous=False)
                    message_count += 1
                
                elif processed_msg.result == ProcessingResult.SKIP:
                    # –ö–æ–º–º–∏—Ç–∏–º offset —Ç.–∫. –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏
                    self.consumer.commit(message=msg, asynchronous=False)
                    message_count += 1
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥—ã–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
                if message_count % 10 == 0 and message_count > 0:
                    self.show_stats()
                    console.print(f"[cyan]üìà –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {message_count} —Å–æ–æ–±—â–µ–Ω–∏–π[/cyan]")
        
        except KeyboardInterrupt:
            console.print("\n[yellow]‚ö†Ô∏è  –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º[/yellow]")
        except Exception as e:
            console.print(f"[red]‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}[/red]")
        finally:
            self.close()
    
    def create_dlq_topic(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ DLQ —Ç–æ–ø–∏–∫–∞ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"""
        try:
            result = subprocess.run(
                ['/opt/kafka/bin/kafka-topics.sh', '--create',
                 '--topic', f'{self.topic}-dlq',
                 '--bootstrap-server', 'localhost:9092',
                 '--partitions', '3',
                 '--replication-factor', '3',
                 '--config', 'retention.ms=604800000'],
                capture_output=True,
                text=True
            )
            
            if result.returncode == 0 or "already exists" in result.stderr:
                console.print(f"[green]‚úÖ DLQ —Ç–æ–ø–∏–∫ {self.topic}-dlq –≥–æ—Ç–æ–≤[/green]")
            else:
                console.print(f"[yellow]‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å DLQ —Ç–æ–ø–∏–∫: {result.stderr}[/yellow]")
        except Exception as e:
            console.print(f"[yellow]‚ö†Ô∏è  –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è DLQ —Ç–æ–ø–∏–∫–∞: {e}[/yellow]")
    
    def close(self):
        """–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Å—é–º–µ—Ä–∞"""
        console.print("\n[yellow]üîí –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –∫–æ–Ω—Å—é–º–µ—Ä–∞...[/yellow]")
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ retry –æ—á–µ—Ä–µ–¥–∏
        if self.retry_queue:
            console.print(f"[yellow]‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ {len(self.retry_queue)} —Å–æ–æ–±—â–µ–Ω–∏–π –≤ retry –æ—á–µ—Ä–µ–¥–∏...[/yellow]")
            time.sleep(3)
        
        # –í—ã–≤–æ–¥–∏–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        console.print("\n" + "="*60)
        console.print("[bold green]üìà –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò –û–®–ò–ë–û–ö[/bold green]")
        console.print("="*60)
        self.show_stats()
        
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Å—é–º–µ—Ä—ã –∏ –ø—Ä–æ–¥—é—Å–µ—Ä—ã
        self.consumer.close()
        self.dlq_producer.flush()
        
        console.print("\n[green]‚úÖ –ö–æ–Ω—Å—é–º–µ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω[/green]")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ —Ñ–∞–π–ª
        with open('consumer_stats.json', 'w') as f:
            json.dump(self.stats, f, indent=2)
        console.print(f"[cyan]üìÅ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ consumer_stats.json[/cyan]")

if __name__ == "__main__":
    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    BOOTSTRAP_SERVERS = "localhost:9092"
    GROUP_ID = "error-handling-group"
    TOPIC = "user-actions"
    
    # –ü–∞—Ä—Å–∏–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
    parser = argparse.ArgumentParser(description='–ö–æ–Ω—Å—é–º–µ—Ä —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫')
    parser.add_argument('--messages', type=int, default=30, help='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏')
    parser.add_argument('--produce', action='store_true', help='–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º')
    args = parser.parse_args()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–æ–ø–∏–∫–∞
    if not check_topic_exists(TOPIC):
        console.print("[red]‚ùå –¢–æ–ø–∏–∫ 'user-actions' –Ω–µ –Ω–∞–π–¥–µ–Ω![/red]")
        console.print("[yellow]üìå –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –æ–∫—Ä—É–∂–µ–Ω–∏—è:[/yellow]")
        console.print("[yellow]   python3 setup_demo.py[/yellow]")
        sys.exit(1)
    
    # –°–æ–∑–¥–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Å—é–º–µ—Ä
    consumer = ErrorHandlingConsumer(
        BOOTSTRAP_SERVERS, 
        GROUP_ID, 
        TOPIC,
        produce_test_messages=args.produce
    )
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
    console.print(f"[cyan]üéØ –¶–µ–ª—å: –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å {args.messages} —Å–æ–æ–±—â–µ–Ω–∏–π[/cyan]")
    consumer.consume(max_messages=args.messages)
EOF

echo "–ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Å—é–º–µ—Ä —Å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫..."
echo "–≠—Ç–æ—Ç –∫–æ–Ω—Å—é–º–µ—Ä —Å–æ–∑–¥–∞—Å—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –Ω–∞—á–Ω–µ—Ç –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫—É."
echo "–û–Ω –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç 30 —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
python3 error_handling_consumer.py --produce --messages 30

# ============================================
# 5. –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –†–ï–ë–ê–õ–ê–ù–°–ò–†–û–í–ö–ò
# ============================================

echo "–°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏..."

cat > rebalance_test.py << 'EOF'
#!/usr/bin/env python3
"""
–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –†–ï–ë–ê–õ–ê–ù–°–ò–†–û–í–ö–ò CONSUMER GROUP

–ß—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
1. –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
2. 5 –≥–æ—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è consumer groups
3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≥—Ä—É–ø–ø —á–µ—Ä–µ–∑ Kafka CLI
4. –ò–º–∏—Ç–∞—Ü–∏—é —Å–±–æ–µ–≤ –∫–æ–Ω—Å—é–º–µ—Ä–æ–≤ (kill -9)
5. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–∞—Ä—Ç–∏—Ü–∏–π —Ç–æ–ø–∏–∫–∞

–°—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏:
1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Å—é–º–µ—Ä–∞ –≤ –≥—Ä—É–ø–ø—É
2. Graceful shutdown –∫–æ–Ω—Å—é–º–µ—Ä–∞
3. –°–±–æ–π –∫–æ–Ω—Å—é–º–µ—Ä–∞ (–∏–º–∏—Ç–∞—Ü–∏—è –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–≥–æ —Å–±–æ—è)
4. –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–∞—Ä—Ç–∏—Ü–∏–π —Ç–æ–ø–∏–∫–∞
5. –ò–∑–º–µ–Ω–µ–Ω–∏–µ subscription –∫–æ–Ω—Å—é–º–µ—Ä–æ–≤

–ö–æ–Ω—Ü–µ–ø—Ü–∏–∏ Kafka:
- Protocol types (consumer, connect)
- Rebalance protocols (eager, cooperative)
- Partition assignment strategies (range, roundrobin, sticky)
- Session timeouts –∏ heartbeat –º–µ—Ö–∞–Ω–∏–∑–º
- Generation ID –∏ member ID

–ó–∞–ø—É—Å–∫:
python3 rebalance_test.py

–†–µ–∑—É–ª—å—Ç–∞—Ç:
–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–æ–Ω—Å–æ–ª—å –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ —Å —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–æ–π.
–ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å/–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –∫–æ–Ω—Å—é–º–µ—Ä—ã –∏ –Ω–∞–±–ª—é–¥–∞—Ç—å –∑–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –ø–∞—Ä—Ç–∏—Ü–∏–π.
"""

import subprocess
import threading
import time
import signal
import sys
from rich.console import Console
from rich.table import Table
from rich.layout import Layout
from rich.live import Live
from rich.panel import Panel
import json

console = Console()

def check_topic_exists(topic="user-actions"):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–æ–ø–∏–∫–∞"""
    try:
        cmd = ['/opt/kafka/bin/kafka-topics.sh', '--describe', 
               '--bootstrap-server', 'localhost:9092', '--topic', topic]
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=5)
        
        if result.returncode != 0 or f"Topic: {topic}" not in result.stdout:
            return False
        return True
    except Exception:
        return False

class RebalanceTester:
    def __init__(self):
        self.processes = {}
        self.rebalance_scenarios = [
            "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Å—é–º–µ—Ä–∞",
            "–£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Å—é–º–µ—Ä–∞", 
            "–°–±–æ–π –∫–æ–Ω—Å—é–º–µ—Ä–∞",
            "–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π",
            "–ò–∑–º–µ–Ω–µ–Ω–∏–µ subscription"
        ]
    
    def start_consumer(self, consumer_id):
        """–ó–∞–ø—É—Å–∫ –∫–æ–Ω—Å—é–º–µ—Ä–∞"""
        cmd = [
            sys.executable, 'manual_commit_consumer.py',
            '--id', f'test-{consumer_id}',
            '--messages', '1000'  # –û–±—Ä–∞–±–æ—Ç–∞–µ—Ç –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π
        ]
        
        process = subprocess.Popen(
            cmd,
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL
        )
        
        self.processes[consumer_id] = process
        console.print(f"[green]‚úÖ –ó–∞–ø—É—â–µ–Ω –∫–æ–Ω—Å—é–º–µ—Ä test-{consumer_id} (PID: {process.pid})[/green]")
        return process
    
    def stop_consumer(self, consumer_id):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Å—é–º–µ—Ä–∞"""
        if consumer_id in self.processes:
            process = self.processes[consumer_id]
            process.terminate()
            process.wait()
            console.print(f"[yellow]üõë –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ–Ω—Å—é–º–µ—Ä test-{consumer_id}[/yellow]")
            del self.processes[consumer_id]
    
    def kill_consumer(self, consumer_id):
        """–°–∏–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–æ–Ω—Å—é–º–µ—Ä–∞ (–∏–º–∏—Ç–∞—Ü–∏—è —Å–±–æ—è)"""
        if consumer_id in self.processes:
            process = self.processes[consumer_id]
            process.kill()  # SIGKILL –≤–º–µ—Å—Ç–æ SIGTERM
            console.print(f"[red]üí• –£–±–∏—Ç –∫–æ–Ω—Å—é–º–µ—Ä test-{consumer_id} (–∏–º–∏—Ç–∞—Ü–∏—è —Å–±–æ—è)[/red]")
            del self.processes[consumer_id]
    
    def check_consumer_group(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è consumer group"""
        try:
            result = subprocess.run(
                ['/opt/kafka/bin/kafka-consumer-groups.sh',
                 '--bootstrap-server', 'localhost:9092',
                 '--group', 'manual-commit-group',
                 '--describe', '--state'],
                capture_output=True,
                text=True,
                timeout=5
            )
            
            if result.returncode == 0:
                return result.stdout
            else:
                return f"–û—à–∏–±–∫–∞: {result.stderr}"
                
        except Exception as e:
            return f"–ò—Å–∫–ª—é—á–µ–Ω–∏–µ: {e}"
    
    def run_scenario(self, scenario_num):
        """–ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏—è —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏"""
        console.print(f"\n[bold magenta]üîÑ –°–¶–ï–ù–ê–†–ò–ô {scenario_num}: {self.rebalance_scenarios[scenario_num-1]}[/bold magenta]")
        
        if scenario_num == 1:
            # –°—Ü–µ–Ω–∞—Ä–∏–π 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Å—é–º–µ—Ä–∞
            console.print("1. –ó–∞–ø—É—Å–∫–∞–µ–º 2 –∫–æ–Ω—Å—é–º–µ—Ä–∞")
            self.start_consumer('A')
            self.start_consumer('B')
            time.sleep(5)
            
            console.print("\n2. –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ—Ç–∏–π –∫–æ–Ω—Å—é–º–µ—Ä")
            self.start_consumer('C')
            time.sleep(5)
            
            console.print("\n3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π")
            console.print(self.check_consumer_group())
            
        elif scenario_num == 2:
            # –°—Ü–µ–Ω–∞—Ä–∏–π 2: –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Å—é–º–µ—Ä–∞
            console.print("1. –ó–∞–ø—É—Å–∫–∞–µ–º 3 –∫–æ–Ω—Å—é–º–µ—Ä–∞")
            self.start_consumer('A')
            self.start_consumer('B') 
            self.start_consumer('C')
            time.sleep(5)
            
            console.print("\n2. –£–¥–∞–ª—è–µ–º –æ–¥–∏–Ω –∫–æ–Ω—Å—é–º–µ—Ä")
            self.stop_consumer('B')
            time.sleep(5)
            
            console.print("\n3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ")
            console.print(self.check_consumer_group())
            
        elif scenario_num == 3:
            # –°—Ü–µ–Ω–∞—Ä–∏–π 3: –°–±–æ–π –∫–æ–Ω—Å—é–º–µ—Ä–∞ (kill -9)
            console.print("1. –ó–∞–ø—É—Å–∫–∞–µ–º 3 –∫–æ–Ω—Å—é–º–µ—Ä–∞")
            self.start_consumer('A')
            self.start_consumer('B')
            self.start_consumer('C')
            time.sleep(5)
            
            console.print("\n2. –ò–º–∏—Ç–∏—Ä—É–µ–º —Å–±–æ–π –∫–æ–Ω—Å—é–º–µ—Ä–∞ B (kill -9)")
            self.kill_consumer('B')
            time.sleep(10)  # –ñ–¥–µ–º –ø–æ–∫–∞ Kafka –æ–±–Ω–∞—Ä—É–∂–∏—Ç —Å–±–æ–π
            
            console.print("\n3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫ Kafka –æ–±—Ä–∞–±–æ—Ç–∞–ª–∞ —Å–±–æ–π")
            console.print(self.check_consumer_group())
            
        elif scenario_num == 4:
            # –°—Ü–µ–Ω–∞—Ä–∏–π 4: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π
            console.print("1. –°–æ–∑–¥–∞–µ–º —Ç–æ–ø–∏–∫ —Å 3 –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏")
            subprocess.run([
                '/opt/kafka/bin/kafka-topics.sh', '--create',
                '--topic', 'test-rebalance',
                '--bootstrap-server', 'localhost:9092',
                '--partitions', '3',
                '--replication-factor', '3'
            ], capture_output=True)
            
            console.print("\n2. –ó–∞–ø—É—Å–∫–∞–µ–º 3 –∫–æ–Ω—Å—é–º–µ—Ä–∞")
            for i in range(3):
                cmd = [
                    sys.executable, 'manual_commit_consumer.py',
                    '--id', f'rebalance-{i}',
                    '--messages', '500'
                ]
                # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —Å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–º —Ç–æ–ø–∏–∫–æ–º
                with open('temp_consumer.py', 'w') as f:
                    f.write('''
import sys
import os
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))
from manual_commit_consumer import ManualCommitConsumer
import time

if __name__ == "__main__":
    consumer = ManualCommitConsumer(
        "localhost:9092",
        "manual-commit-group",
        "test-rebalance",
        f'rebalance-{sys.argv[1]}'
    )
    consumer.consume(max_messages=500)
''')
                
                process = subprocess.Popen(
                    [sys.executable, 'temp_consumer.py', str(i)],
                    stdout=subprocess.DEVNULL,
                    stderr=subprocess.DEVNULL
                )
                self.processes[f'rebalance-{i}'] = process
            
            time.sleep(5)
            
            console.print("\n3. –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–∞—Ä—Ç–∏—Ü–∏–∏ –¥–æ 6")
            subprocess.run([
                '/opt/kafka/bin/kafka-topics.sh', '--alter',
                '--topic', 'test-rebalance',
                '--bootstrap-server', 'localhost:9092',
                '--partitions', '6'
            ], capture_output=True)
            
            time.sleep(5)
            
            console.print("\n4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ")
            result = subprocess.run([
                '/opt/kafka/bin/kafka-consumer-groups.sh',
                '--bootstrap-server', 'localhost:9092',
                '--group', 'manual-commit-group',
                '--describe'
            ], capture_output=True, text=True)
            console.print(result.stdout)
            
            # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            if os.path.exists('temp_consumer.py'):
                os.remove('temp_consumer.py')
            
        elif scenario_num == 5:
            # –°—Ü–µ–Ω–∞—Ä–∏–π 5: –ò–∑–º–µ–Ω–µ–Ω–∏–µ subscription
            console.print("1. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Å—é–º–µ—Ä –Ω–∞ —Ç–æ–ø–∏–∫–µ A")
            # –î–ª—è —ç—Ç–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –Ω—É–∂–Ω—ã –¥–≤–∞ —Ç–æ–ø–∏–∫–∞
            subprocess.run([
                '/opt/kafka/bin/kafka-topics.sh', '--create',
                '--topic', 'topic-a',
                '--bootstrap-server', 'localhost:9092',
                '--partitions', '3',
                '--replication-factor', '3'
            ], capture_output=True)
            
            subprocess.run([
                '/opt/kafka/bin/kafka-topics.sh', '--create',
                '--topic', 'topic-b',
                '--bootstrap-server', 'localhost:9092',
                '--partitions', '3',
                '--replication-factor', '3'
            ], capture_output=True)
            
            console.print("\n2. –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (—Å–ª–æ–∂–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π)")
            
        # –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ —Å—Ü–µ–Ω–∞—Ä–∏—è
        console.print("\n[yellow]üßπ –û—á–∏—Å—Ç–∫–∞...[/yellow]")
        for consumer_id in list(self.processes.keys()):
            self.stop_consumer(consumer_id)
        
        time.sleep(2)
    
    def interactive_test(self):
        """–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"""
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ø–∏–∫
        if not check_topic_exists("user-actions"):
            console.print("[red]‚ùå –¢–æ–ø–∏–∫ 'user-actions' –Ω–µ –Ω–∞–π–¥–µ–Ω![/red]")
            console.print("[yellow]üìå –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –æ–∫—Ä—É–∂–µ–Ω–∏—è:[/yellow]")
            console.print("[yellow]   python3 setup_demo.py[/yellow]")
            return
        
        console.print("[bold blue]=" * 60)
        console.print("         –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –†–ï–ë–ê–õ–ê–ù–°–ò–†–û–í–ö–ò")
        console.print("=" * 60)
        
        while True:
            console.print("\n[bold]–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:[/bold]")
            console.print("  start <id>    - –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Å—é–º–µ—Ä")
            console.print("  stop <id>     - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Å—é–º–µ—Ä (graceful)")
            console.print("  kill <id>     - –£–±–∏—Ç—å –∫–æ–Ω—Å—é–º–µ—Ä (–∏–º–∏—Ç–∞—Ü–∏—è —Å–±–æ—è)")
            console.print("  list          - –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Å—é–º–µ—Ä–æ–≤")
            console.print("  check         - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å consumer group")
            console.print("  scenario <n>  - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π (1-5)")
            console.print("  quit          - –í—ã–π—Ç–∏")
            
            try:
                command = input("\n–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É: ").strip().split()
                
                if not command:
                    continue
                
                if command[0] == 'start' and len(command) == 2:
                    self.start_consumer(command[1])
                    
                elif command[0] == 'stop' and len(command) == 2:
                    self.stop_consumer(command[1])
                    
                elif command[0] == 'kill' and len(command) == 2:
                    self.kill_consumer(command[1])
                    
                elif command[0] == 'list':
                    console.print("\n[bold]–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω—Å—é–º–µ—Ä—ã:[/bold]")
                    for id, process in self.processes.items():
                        status = "—Ä–∞–±–æ—Ç–∞–µ—Ç" if process.poll() is None else "–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
                        console.print(f"  {id}: PID {process.pid} ({status})")
                    
                elif command[0] == 'check':
                    console.print("\n[bold]–°–æ—Å—Ç–æ—è–Ω–∏–µ consumer group:[/bold]")
                    console.print(self.check_consumer_group())
                    
                elif command[0] == 'scenario' and len(command) == 2:
                    try:
                        scenario_num = int(command[1])
                        if 1 <= scenario_num <= 5:
                            self.run_scenario(scenario_num)
                        else:
                            console.print("[red]‚ùå –ù–æ–º–µ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 5[/red]")
                    except ValueError:
                        console.print("[red]‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è[/red]")
                        
                elif command[0] == 'quit':
                    break
                    
                else:
                    console.print("[red]‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞[/red]")
                    
            except KeyboardInterrupt:
                console.print("\n[yellow]‚ö†Ô∏è  –í–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é...[/yellow]")
                continue
            except EOFError:
                break
        
        # –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
        console.print("\n[yellow]üßπ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã, –æ—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Å—é–º–µ—Ä–æ–≤...[/yellow]")
        for consumer_id in list(self.processes.keys()):
            self.stop_consumer(consumer_id)

if __name__ == "__main__":
    tester = RebalanceTester()
    tester.interactive_test()
    console.print("\n[bold green]‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ![/bold green]")
EOF

echo "–ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏..."
echo "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤"
python3 rebalance_test.py

# ============================================
# 6. –í–ò–ó–£–ê–õ–¨–ù–ê–Ø –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –†–ï–ë–ê–õ–ê–ù–°–ò–†–û–í–ö–ò
# ============================================

echo "–°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –∫–æ–Ω—Å—é–º–µ—Ä –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏..."

cat > simple_visual_consumer.py << 'EOF'
#!/usr/bin/env python3
"""
–ü–†–û–°–¢–û–ô –ö–û–ù–°–Æ–ú–ï–† –î–õ–Ø –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ò –†–ï–ë–ê–õ–ê–ù–°–ò–†–û–í–ö–ò

–ß—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
1. –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é Kafka Consumer
2. –í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –∫–æ–Ω—Å—é–º–µ—Ä–∞
3. –ü—Ä–æ—Å—Ç–æ—Ç—É –∑–∞–ø—É—Å–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç —Ä–∞–±–æ—Ç—ã –∫–æ–Ω—Å—é–º–µ—Ä–∞
- –õ–µ–≥–∫–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–∞–ª–∞—Ö

–ó–∞–ø—É—Å–∫ (–≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–∞–ª–∞—Ö):
python3 simple_visual_consumer.py --id consumer-1
python3 simple_visual_consumer.py --id consumer-2
python3 simple_visual_consumer.py --id consumer-3

–†–µ–∑—É–ª—å—Ç–∞—Ç:
–í –∫–∞–∂–¥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ–Ω—Å—é–º–µ—Ä,
–º–æ–∂–Ω–æ –Ω–∞–±–ª—é–¥–∞—Ç—å –∑–∞ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–æ–π –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏/–æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤.
"""

from confluent_kafka import Consumer, KafkaError
import sys
import signal
import time

class SimpleVisualConsumer:
    def __init__(self, consumer_id, group_id="visual-demo-group"):
        self.config = {
            'bootstrap.servers': 'localhost:9092',
            'group.id': group_id,
            'client.id': consumer_id,
            'auto.offset.reset': 'earliest',
            'enable.auto.commit': True,
            'session.timeout.ms': 10000,
            'max.poll.interval.ms': 300000,
        }
        
        self.consumer = Consumer(self.config)
        self.consumer_id = consumer_id
        self.running = True
        
        signal.signal(signal.SIGINT, self.signal_handler)
        signal.signal(signal.SIGTERM, self.signal_handler)
        
        print(f"[{consumer_id}] –ö–æ–Ω—Å—é–º–µ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –≥—Ä—É–ø–ø–∞: {group_id}")
    
    def signal_handler(self, signum, frame):
        print(f"\n[{self.consumer_id}] –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª {signum}, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ...")
        self.running = False
    
    def consume(self, topic="user-actions"):
        print(f"[{self.consumer_id}] –ü–æ–¥–ø–∏—Å—ã–≤–∞—é—Å—å –Ω–∞ —Ç–æ–ø–∏–∫ {topic}")
        self.consumer.subscribe([topic])
        
        msg_count = 0
        
        try:
            while self.running:
                msg = self.consumer.poll(timeout=1.0)
                
                if msg is None:
                    continue
                
                if msg.error():
                    if msg.error().code() == KafkaError._PARTITION_EOF:
                        continue
                    print(f"[{self.consumer_id}] –û—à–∏–±–∫–∞: {msg.error()}")
                    continue
                
                msg_count += 1
                if msg_count % 10 == 0:
                    print(f"[{self.consumer_id}] –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {msg_count}")
                
                # –ò–º–∏—Ç–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
                time.sleep(0.1)
                
        except KeyboardInterrupt:
            print(f"\n[{self.consumer_id}] –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        except Exception as e:
            print(f"[{self.consumer_id}] –û—à–∏–±–∫–∞: {e}")
        finally:
            self.close()
    
    def close(self):
        print(f"[{self.consumer_id}] –ó–∞–∫—Ä—ã–≤–∞—é –∫–æ–Ω—Å—é–º–µ—Ä...")
        self.consumer.close()
        print(f"[{self.consumer_id}] –ö–æ–Ω—Å—é–º–µ—Ä –∑–∞–∫—Ä—ã—Ç")

if __name__ == "__main__":
    import argparse
    
    parser = argparse.ArgumentParser(description='–ü—Ä–æ—Å—Ç–æ–π –∫–æ–Ω—Å—é–º–µ—Ä –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏')
    parser.add_argument('--id', required=True, help='ID –∫–æ–Ω—Å—é–º–µ—Ä–∞')
    parser.add_argument('--topic', default='user-actions', help='–¢–æ–ø–∏–∫ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏')
    parser.add_argument('--group', default='visual-demo-group', help='Consumer group ID')
    
    args = parser.parse_args()
    
    print(f"=== –ó–ê–ü–£–°–ö –ö–û–ù–°–Æ–ú–ï–†–ê {args.id} ===")
    consumer = SimpleVisualConsumer(args.id, args.group)
    consumer.consume(args.topic)
EOF

echo "–°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏..."

cat > visual_demo_2_3.py << 'EOF'
#!/usr/bin/env python3
"""
–í–ò–ó–£–ê–õ–¨–ù–ê–Ø –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –†–ï–ë–ê–õ–ê–ù–°–ò–†–û–í–ö–ò –î–õ–Ø –õ–ê–ë–û–†–ê–¢–û–†–ù–û–ô 2.3

–ß—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
1. –ü–æ—à–∞–≥–æ–≤—É—é –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
2. –ó–∞–ø—É—Å–∫ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫—É –∫–æ–Ω—Å—é–º–µ—Ä–æ–≤ –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é
3. –ü—Ä–æ–≤–µ—Ä–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è consumer group –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
4. –ù–∞–≥–ª—è–¥–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–π

–°—Ü–µ–Ω–∞—Ä–∏–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏:
1. –ó–∞–ø—É—Å–∫ –æ–¥–Ω–æ–≥–æ –∫–æ–Ω—Å—é–º–µ—Ä–∞ (–ø–æ–ª—É—á–∞–µ—Ç –≤—Å–µ 6 –ø–∞—Ä—Ç–∏—Ü–∏–π)
2. –ó–∞–ø—É—Å–∫ –≤—Ç–æ—Ä–æ–≥–æ –∫–æ–Ω—Å—é–º–µ—Ä–∞ (—Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞, –ø–æ 3 –ø–∞—Ä—Ç–∏—Ü–∏–∏ –∫–∞–∂–¥–æ–º—É)
3. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ç–æ—Ä–æ–≥–æ –∫–æ–Ω—Å—é–º–µ—Ä–∞ (—Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞, –≤—Å–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –ø–µ—Ä–≤–æ–º—É)
4. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏

–ó–∞–ø—É—Å–∫:
python3 visual_demo_2_3.py

–†–µ–∑—É–ª—å—Ç–∞—Ç:
–ü–æ—à–∞–≥–æ–≤–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å–æ—Å—Ç–æ—è–Ω–∏—è.
–ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –ª–µ–∫—Ü–∏–π –∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π.
"""

import subprocess
import time
import threading

def run_consumer(consumer_id):
    """–ó–∞–ø—É—Å–∫ –∫–æ–Ω—Å—é–º–µ—Ä–∞"""
    cmd = ['python3', 'simple_visual_consumer.py', '--id', consumer_id]
    
    process = subprocess.Popen(
        cmd,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True,
        bufsize=1
    )
    
    def read_output(pipe, name):
        for line in pipe:
            if line.strip():
                print(f"[{name}] {line.strip()}")
    
    threading.Thread(target=read_output, args=(process.stdout, consumer_id), daemon=True).start()
    threading.Thread(target=read_output, args=(process.stderr, consumer_id), daemon=True).start()
    
    return process

def check_consumer_group():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è consumer group"""
    cmd = [
        '/opt/kafka/bin/kafka-consumer-groups.sh',
        '--bootstrap-server', 'localhost:9092',
        '--group', 'visual-demo-group',
        '--describe'
    ]
    
    result = subprocess.run(cmd, capture_output=True, text=True, timeout=5)
    return result.stdout if result.returncode == 0 else result.stderr

def main():
    print("–í–ò–ó–£–ê–õ–¨–ù–ê–Ø –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –†–ï–ë–ê–õ–ê–ù–°–ò–†–û–í–ö–ò")
    print("=" * 60)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ø–∏–∫
    print("üîç –ü—Ä–æ–≤–µ—Ä—è—é —Ç–æ–ø–∏–∫ 'user-actions'...")
    try:
        cmd = ['/opt/kafka/bin/kafka-topics.sh', '--describe', 
               '--bootstrap-server', 'localhost:9092', '--topic', 'user-actions']
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=5)
        
        if result.returncode != 0 or "Topic: user-actions" not in result.stdout:
            print("‚ùå –¢–æ–ø–∏–∫ 'user-actions' –Ω–µ –Ω–∞–π–¥–µ–Ω!")
            print("\nüìå –í–∞–º –Ω—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é:")
            print("   1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: python3 setup_demo.py")
            print("   2. –°–æ–∑–¥–∞–π—Ç–µ —Ç–æ–ø–∏–∫ –∏ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ")
            print("   3. –ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç—É –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é —Å–Ω–æ–≤–∞")
            return
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ: {e}")
        return
    
    processes = {}
    
    input("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –∫–æ–Ω—Å—é–º–µ—Ä–∞...")
    processes['consumer-1'] = run_consumer('consumer-1')
    time.sleep(5)
    print("\n–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ consumer-1:")
    print(check_consumer_group())
    
    input("\n–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Ç–æ—Ä–æ–≥–æ –∫–æ–Ω—Å—é–º–µ—Ä–∞...")
    processes['consumer-2'] = run_consumer('consumer-2')
    time.sleep(5)
    print("\n–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ consumer-2 (—Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞):")
    print(check_consumer_group())
    
    input("\n–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ consumer-2...")
    processes['consumer-2'].terminate()
    processes['consumer-2'].wait()
    del processes['consumer-2']
    time.sleep(5)
    print("\n–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ consumer-2 (—Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞):")
    print(check_consumer_group())
    
    input("\n–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏...")
    for name, process in processes.items():
        process.terminate()
        process.wait()
    
    print("\n‚úÖ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")

if __name__ == "__main__":
    main()
EOF

echo "–î–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
echo "python3 visual_demo_2_3.py"

# ============================================
# 7. –ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –ò –ú–û–ù–ò–¢–û–†–ò–ù–ì
# ============================================

echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–±–æ—Ç—ã –∫–æ–Ω—Å—é–º–µ—Ä–æ–≤..."

# 7.1. –ü—Ä–æ–≤–µ—Ä—è–µ–º consumer groups
echo "–°–ø–∏—Å–æ–∫ consumer groups:"
/opt/kafka/bin/kafka-consumer-groups.sh \
  --bootstrap-server localhost:9092 \
  --list

# 7.2. –ü—Ä–æ–≤–µ—Ä—è–µ–º offset'—ã
echo "Offset'—ã –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –≥—Ä—É–ø–ø:"
for group in "basic-consumer-group" "manual-commit-group" "error-handling-group"; do
  echo "–ì—Ä—É–ø–ø–∞: $group"
  /opt/kafka/bin/kafka-consumer-groups.sh \
    --bootstrap-server localhost:9092 \
    --group $group \
    --describe 2>/dev/null | head -5 || echo "  –ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
done

# 7.3. –ü—Ä–æ–≤–µ—Ä—è–µ–º DLQ —Ç–æ–ø–∏–∫ (–µ—Å–ª–∏ —Å–æ–∑–¥–∞–ª—Å—è)
echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º DLQ —Ç–æ–ø–∏–∫:"
/opt/kafka/bin/kafka-topics.sh --list --bootstrap-server localhost:9092 | grep -i dlq || \
  echo "DLQ —Ç–æ–ø–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

# 7.4. –ß–∏—Ç–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ DLQ (–µ—Å–ª–∏ –µ—Å—Ç—å)
if /opt/kafka/bin/kafka-topics.sh --list --bootstrap-server localhost:9092 | grep -q "user-actions-dlq"; then
  echo "–ß–∏—Ç–∞–µ–º 2 —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ DLQ:"
  timeout 5 /opt/kafka/bin/kafka-console-consumer.sh \
    --topic user-actions-dlq \
    --bootstrap-server localhost:9092 \
    --from-beginning \
    --max-messages 2 \
    --timeout-ms 5000 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å DLQ"
fi

# ============================================
# 8. –û–ß–ò–°–¢–ö–ê –ò –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï
# ============================================

echo "=== –õ–ê–ë–û–†–ê–¢–û–†–ù–ê–Ø 2.3 –ó–ê–í–ï–†–®–ï–ù–ê ==="
echo ""
echo "üéâ –í–´ –ü–û–ó–ù–ê–ö–û–ú–ò–õ–ò–°–¨ –°:"
echo "   1. –ë–∞–∑–æ–≤—ã–º –∫–æ–Ω—Å—é–º–µ—Ä–æ–º —Å –∞–≤—Ç–æ–∫–æ–º–º–∏—Ç–æ–º"
echo "   2. –†—É—á–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º offset (exactly-once —Å–µ–º–∞–Ω—Ç–∏–∫–∞)"
echo "   3. Consumer groups –∏ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–æ–π"
echo "   4. –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ (Circuit Breaker, Retry, DLQ)"
echo "   5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏"
echo "   6. –í–∏–∑—É–∞–ª—å–Ω–æ–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–µ–π —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏"
echo ""
echo "üìÅ –°–û–ó–î–ê–ù–ù–´–ï –§–ê–ô–õ–´:"
echo "   - setup_demo.py               # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è"
echo "   - basic_consumer.py           # –ë–∞–∑–æ–≤—ã–π –∫–æ–Ω—Å—é–º–µ—Ä"
echo "   - manual_commit_consumer.py   # –†—É—á–Ω–æ–π –∫–æ–º–º–∏—Ç offset"
echo "   - consumer_group_demo.py      # –î–µ–º–æ consumer group"
echo "   - error_handling_consumer.py  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫"
echo "   - rebalance_test.py           # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏"
echo "   - simple_visual_consumer.py   # –ü—Ä–æ—Å—Ç–æ–π –∫–æ–Ω—Å—é–º–µ—Ä –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏"
echo "   - visual_demo_2_3.py          # –í–∏–∑—É–∞–ª—å–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è"
echo "   - dlq_*.json                  # Dead Letter Queue —Å–æ–æ–±—â–µ–Ω–∏—è"
echo "   - consumer_stats.json         # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏"
echo ""
echo "üîß –ö–õ–Æ–ß–ï–í–´–ï –ö–û–ù–¶–ï–ü–¶–ò–ò –î–õ–Ø –ó–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø:"
echo "   1. –ê–≤—Ç–æ–∫–æ–º–º–∏—Ç vs –†—É—á–Ω–æ–π –∫–æ–º–º–∏—Ç: trade-off –º–µ–∂–¥—É –ø—Ä–æ—Å—Ç–æ—Ç–æ–π –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å—é"
echo "   2. Consumer Group: –º–µ—Ö–∞–Ω–∏–∑–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏"
echo "   3. –†–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–∞–≤–∞ –≥—Ä—É–ø–ø—ã"
echo "   4. Circuit Breaker: –∑–∞—â–∏—Ç–∞ –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –≤ downstream —Å–∏—Å—Ç–µ–º–∞—Ö"
echo "   5. Dead Letter Queue (DLQ): —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ—É–¥–∞—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞"
echo ""
echo "‚ö†Ô∏è  –ß–ê–°–¢–´–ï –û–®–ò–ë–ö–ò –ò –ö–ê–ö –ò–• –ò–ó–ë–ï–ñ–ê–¢–¨:"
echo "   1. –ü—Ä–æ–ø—É—Å–∫ commit() ‚Üí –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏"
echo "   2. –°–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–π commit() ‚Üí —Å–Ω–∏–∂–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"
echo "   3. –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ rebalance callback ‚Üí –ø–æ—Ç–µ—Ä—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–µ"
echo "   4. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ ‚Üí silent failures"
echo "   5. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π max.poll.interval.ms ‚Üí false rebalances"
echo ""
echo "üöÄ –ü–†–û–î–í–ò–ù–£–¢–´–ï –¢–ï–ú–´ –î–õ–Ø –°–ê–ú–û–°–¢–û–Ø–¢–ï–õ–¨–ù–û–ì–û –ò–ó–£–ß–ï–ù–ò–Ø:"
echo "   1. Exactly-once —Å–µ–º–∞–Ω—Ç–∏–∫–∞ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–º–∏ –∫–æ–Ω—Å—é–º–µ—Ä–∞–º–∏"
echo "   2. Cooperative rebalancing (incremental rebalance)"
echo "   3. Consumer interceptor –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è"
echo "   4. Dynamic partition assignment strategies"
echo "   5. Integration —Å Apache Schema Registry"
echo ""
echo "üìö –ü–û–õ–ï–ó–ù–´–ï –†–ï–°–£–†–°–´:"
echo "   - Kafka Consumer Configs: https://kafka.apache.org/documentation/#consumerconfigs"
echo "   - Consumer Groups: https://www.confluent.io/blog/how-to-use-apache-kafka-to-build-a-scalable-database/"
echo "   - Error Handling Patterns: https://www.confluent.io/blog/error-handling-patterns-in-kafka/"
echo "   - Consumer Rebalancing: https://www.confluent.io/blog/cooperative-rebalancing-in-kafka-streams-consumer-ksqldb/"
echo ""
echo "–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –ú–æ–¥—É–ª—å 3 ‚Äî –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ Kafka (Streams, Connect, Monitoring)"
echo ""
echo "üìù –ö–†–ê–¢–ö–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ó–ê–ü–£–°–ö–£:"
echo "   1. python3 setup_demo.py                     # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è"
echo "   2. python3 basic_consumer.py                 # –ë–∞–∑–æ–≤—ã–π –∫–æ–Ω—Å—é–º–µ—Ä"
echo "   3. python3 manual_commit_consumer.py --id consumer-1 --messages 50"
echo "   4. python3 consumer_group_demo.py            # Consumer group (–≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç 3)"
echo "   5. python3 error_handling_consumer.py        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫"
echo "   6. python3 rebalance_test.py                 # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏"
echo "   7. python3 visual_demo_2_3.py                # –í–∏–∑—É–∞–ª—å–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è"
[file content end]