–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è 2.2: –ü—Ä–æ–¥—é—Å–µ—Ä—ã Apache Kafka –Ω–∞ Python

–¶–µ–ª—å: –û—Å–≤–æ–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–¥—é—Å–µ—Ä–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ —É—Ä–æ–≤–Ω—è–º–∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 30-45 –º–∏–Ω—É—Ç
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ: 
1. –†–∞–±–æ—á–∏–π –∫–ª–∞—Å—Ç–µ—Ä Kafka –∏–∑ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π 1
2. Python 3.8+ –∏ pip
3. –¢–æ–ø–∏–∫ –¥–ª—è —Ç–µ—Å—Ç–æ–≤

"–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ Kafka ‚Äî —ç—Ç–æ –ø–æ—á—Ç–æ–≤–∞—è —Å–ª—É–∂–±–∞, –∞ –ø—Ä–æ–¥—é—Å–µ—Ä—ã ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–∏ –ø–∏—Å–µ–º"
acks=0 ‚Äî –±—Ä–æ—Å–∏–ª –ø–∏—Å—å–º–æ –≤ –ø–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫ –∏ –ø–æ—à—ë–ª –¥–∞–ª—å—à–µ (–±—ã—Å—Ç—Ä–æ, –Ω–æ –ø–∏—Å—å–º–æ –º–æ–∂–µ—Ç –ø–æ—Ç–µ—Ä—è—Ç—å—Å—è)
acks=1 ‚Äî –æ—Ç–¥–∞–ª –ø–∏—Å—å–º–æ –ø–æ—á—Ç–∞–ª—å–æ–Ω—É –∏ –ø–æ–ª—É—á–∏–ª –∫–≤–∏—Ç–∞–Ω—Ü–∏—é (–Ω–∞–¥—ë–∂–Ω–µ–µ, –Ω–æ –∂–¥–∞—Ç—å)
acks=all ‚Äî –ø–∏—Å—å–º–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–º (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –Ω–∞–¥—ë–∂–Ω–æ)
retry ‚Äî –µ—Å–ª–∏ –ø–æ—á—Ç–∞–ª—å–æ–Ω –∑–∞–±–æ–ª–µ–ª, –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–≥–æ
async ‚Äî –Ω–∞–Ω—è—Ç—å –ø–æ–º–æ—â–Ω–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Ä–∞–∑–Ω–æ—Å–∏—Ç—å –ø–∏—Å—å–º–∞, –∞ –≤—ã –±—É–¥–µ—Ç–µ –∑–∞–ø–æ–ª–Ω—è—Ç—å –Ω–æ–≤—ã–µ

# ============================================
# 1. –ü–û–î–ì–û–¢–û–í–ö–ê –û–ö–†–£–ñ–ï–ù–ò–Ø
# ============================================

# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ kafka1.lab
ssh kafka1.lab

# 1.1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏..."
sudo apt update
sudo apt install -y python3 python3-pip python3-venv git

# 1.2. –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
mkdir -p ~/kafka-lab/producers
cd ~/kafka-lab/producers
python3 -m venv venv
source venv/bin/activate

# 1.3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º confluent-kafka –∏ —É—Ç–∏–ª–∏—Ç—ã..."
pip install confluent-kafka
pip install python-dotenv
pip install faker  # –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
pip install psutil  # –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
pip install rich   # –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞

# 1.4. –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–æ–ø–∏–∫
echo "–°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Ç–æ–ø–∏–∫–∏..."
/opt/kafka/bin/kafka-topics.sh --create \
  --topic test-producer \
  --bootstrap-server localhost:9092 \
  --partitions 3 \
  --replication-factor 3 \
  --config retention.ms=3600000

/opt/kafka/bin/kafka-topics.sh --create \
  --topic test-perf \
  --bootstrap-server localhost:9092 \
  --partitions 6 \
  --replication-factor 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ
/opt/kafka/bin/kafka-topics.sh --list --bootstrap-server localhost:9092 | grep test

–û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤—Å–µ—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
–í—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É confluent-kafka-python ‚Äî –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Python-–∫–ª–∏–µ–Ω—Ç –¥–ª—è Kafka –æ—Ç Confluent. –≠—Ç–æ –Ω–µ "—Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–∞—è" –±–∏–±–ª–∏–æ—Ç–µ–∫–∞, –∞ –∏–º–µ–Ω–Ω–æ —Ç–∞, –∫–æ—Ç–æ—Ä–∞—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.

1. basic_producer.py ‚Äî –ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–¥—é—Å–µ—Ä —Å —Ä–∞–∑–Ω—ã–º–∏ —É—Ä–æ–≤–Ω—è–º–∏ acks
–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:
–î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ç—Ä–∏ —É—Ä–æ–≤–Ω—è –≥–∞—Ä–∞–Ω—Ç–∏–π –¥–æ—Å—Ç–∞–≤–∫–∏ —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä acks:
acks=0 ‚Äî "–æ—Ç–ø—Ä–∞–≤–∏–ª –∏ –∑–∞–±—ã–ª" (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å, –≤–æ–∑–º–æ–∂–Ω–∞ –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö)
acks=1 ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç –ª–∏–¥–µ—Ä–∞ (–±–∞–ª–∞–Ω—Å —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
acks=all ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç –≤—Å–µ—Ö —Ä–µ–ø–ª–∏–∫ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å, –º–µ–¥–ª–µ–Ω–Ω–µ–µ)
–ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏:
# 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–¥—é—Å–µ—Ä–∞
config = {
    'bootstrap.servers': 'kafka1.lab:9092,kafka2.lab:9092,kafka3.lab:9092',
    'acks': 'all',  # ‚Üê –°–ê–ú–ê–Ø –í–ê–ñ–ù–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê!
    'retries': 5,   # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ
    'linger.ms': 5, # –ñ–¥—ë–º 5–º—Å, —á—Ç–æ–±—ã –Ω–∞–∫–æ–ø–∏—Ç—å –±–∞—Ç—á
    'batch.size': 16384, # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–∞—á–∫–∞–º–∏ –ø–æ 16KB
    'compression.type': 'snappy', # –°–∂–∏–º–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
}

# 2. Callback-—Ñ—É–Ω–∫—Ü–∏—è (–æ–±—Ä–∞—Ç–Ω—ã–π –≤—ã–∑–æ–≤)
def delivery_report(err, msg):
    if err is not None:
        print(f'–û—à–∏–±–∫–∞: {err}')
    else:
        print(f'–°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ –ø–∞—Ä—Ç–∏—Ü–∏—é {msg.partition()}')
        
# 3. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å callback
producer.produce(
    topic='orders',
    key='user123',       # –ö–ª—é—á –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏—é
    value='{"order": 1}',
    callback=delivery_report  # –í—ã–∑–æ–≤–µ—Ç—Å—è, –∫–æ–≥–¥–∞ Kafka –æ—Ç–≤–µ—Ç–∏—Ç
)
–ß—Ç–æ –≤—ã —É–≤–∏–¥–∏—Ç–µ –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ:
acks=0: 3100 —Å–æ–æ–±—â/—Å–µ–∫, –Ω–æ –º–æ–∂–µ—Ç –ø–æ—Ç–µ—Ä—è—Ç—å 1-2%
acks=1: 2800 —Å–æ–æ–±—â/—Å–µ–∫, –Ω–∞–¥–µ–∂–Ω–µ–µ  
acks=all: 1200 —Å–æ–æ–±—â/—Å–µ–∫, –Ω–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –¥–æ—Å—Ç–∞–≤–∏—Ç
–í—ã–±–∏—Ä–∞–π—Ç–µ acks –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∞–∂–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö!

2. retry_producer.py ‚Äî –ü—Ä–æ–¥—é—Å–µ—Ä —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ –∏ retry
–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–±–æ–µ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –≤ production:
–≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ ‚Äî –µ—Å–ª–∏ –æ—à–∏–±–∫–∞, –∂–¥—ë–º 100–º—Å, –ø–æ—Ç–æ–º 200–º—Å, –ø–æ—Ç–æ–º 400–º—Å...
Circuit Breaker ‚Äî –µ—Å–ª–∏ –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥, –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É
Dead Letter Queue (DLQ) ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–µ—É–¥–∞–≤—à–∏–µ—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ñ–∞–π–ª
–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—à–∏–±–æ–∫ ‚Äî —Ä–∞–∑–Ω—ã–µ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ-—Ä–∞–∑–Ω–æ–º—É
–ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏:
# 1. –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —Å –¥–∂–∏—Ç—Ç–µ—Ä–æ–º
def exponential_backoff(attempt):
    delay = 100 * (2 ** attempt)  # 100, 200, 400, 800...
    jitter = random.uniform(0.8, 1.2)  # ¬±20% —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
    return delay * jitter

# 2. Circuit Breaker –ø–∞—Ç—Ç–µ—Ä–Ω
error_rate = error_count / 100
if error_rate > 0.3:  # –ï—Å–ª–∏ >30% –æ—à–∏–±–æ–∫
    print("Circuit Breaker –æ—Ç–∫—Ä—ã—Ç! –ü–∞—É–∑–∞ 5 —Å–µ–∫—É–Ω–¥")
    time.sleep(5)

# 3. Dead Letter Queue (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–µ—É–¥–∞—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
failed_messages = []
for message in failed:
    with open('failed_messages.json', 'a') as f:
        json.dump(message, f)  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–∑–∂–µ

–¢–∏–ø—ã –æ—à–∏–±–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º:
Timeout –æ—à–∏–±–∫–∏ (-185, -195) ‚Äî –º–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –±—Ä–æ–∫–µ—Ä–∞ (-187, -189) ‚Äî –Ω—É–∂–Ω–æ –ø–æ–¥–æ–∂–¥–∞—Ç—å
–û—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (-192) ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω—É–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
–í production –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω—É–∂–µ–Ω retry –º–µ—Ö–∞–Ω–∏–∑–º!

3. async_producer.py ‚Äî –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø—Ä–æ–¥—é—Å–µ—Ä —Å –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å—é
–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:
–î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—É—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É:
–û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ ‚Äî –±—ã—Å—Ç—Ä–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
Callback-–ø–æ—Ç–æ–∫ ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã –æ—Ç Kafka
–ò–∑–º–µ—Ä–µ–Ω–∏–µ latency ‚Äî —Å—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–Ω–∏–º–∞–µ—Ç –¥–æ—Å—Ç–∞–≤–∫–∞
–ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ ‚Äî –∫—Ä–∞—Å–∏–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å Rich
–ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏:
# 1. –î–≤–∞ –ø–æ—Ç–æ–∫–∞: –æ—Å–Ω–æ–≤–Ω–æ–π –∏ callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫
# –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫:
producer.produce(topic, value, callback=self._delivery_callback)

# –û—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–ª—è callback:
def _process_callbacks(self):
    while True:
        result = self.callback_queue.get()  # –ë–µ—Ä–µ–º –∏–∑ –æ—á–µ—Ä–µ–¥–∏
        if result['err']:
            self.stats['failed'] += 1
        else:
            self.stats['confirmed'] += 1

# 2. –ò–∑–º–µ—Ä–µ–Ω–∏–µ latency (–∑–∞–¥–µ—Ä–∂–∫–∏)
start_time = time.time()
producer.produce(topic, value, callback=...)
# –í callback:
latency = time.time() - start_time  # –°–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ —à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ

# 3. Rich –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
from rich.progress import Progress
with Progress() as progress:
    task = progress.add_task("–û—Ç–ø—Ä–∞–≤–∫–∞...", total=1000)
    for i in range(1000):
        producer.produce(...)
        progress.update(task, advance=1)

–ú–µ—Ç—Ä–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –∏–∑–º–µ—Ä—è–µ–º:
Throughput ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É
Latency (avg) ‚Äî —Å—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
Latency (p95) ‚Äî 95% —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ —ç—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
Success rate ‚Äî –ø—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö –¥–æ—Å—Ç–∞–≤–æ–∫
–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å + –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å = –≤—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å!

4. performance_test.py ‚Äî –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:
–°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç 5 —Ä–∞–∑–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –ø—Ä–æ–¥—é—Å–µ—Ä–∞, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å, –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–ª–∏—è—é—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
–ë–∞–∑–æ–≤—ã–π ‚Äî –±–∞–ª–∞–Ω—Å —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
–í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî –º–∞–∫—Å–∏–º—É–º —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É
–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å ‚Äî –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
–ù–∏–∑–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ ‚Äî –¥–ª—è —á–∞—Ç–æ–≤, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
–î–ª—è –±–æ–ª—å—à–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π ‚Äî –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ 1MB+ —Å–æ–æ–±—â–µ–Ω–∏—è
–ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏:
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö use cases:
configs = {
    'high-throughput': {
        'acks': '1',           # –ë—ã—Å—Ç—Ä–æ, –Ω–æ –º–æ–∂–Ω–æ –ø–æ—Ç–µ—Ä—è—Ç—å
        'compression.type': 'snappy',  # –•–æ—Ä–æ—à–µ–µ —Å–∂–∞—Ç–∏–µ
        'batch.size': 65536,   # –ë–æ–ª—å—à–∏–µ –±–∞—Ç—á–∏
    },
    'high-reliability': {
        'acks': 'all',         # –ú–µ–¥–ª–µ–Ω–Ω–æ, –Ω–æ –Ω–∞–¥–µ–∂–Ω–æ
        'enable.idempotence': True,  # –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
        'max.in.flight.requests.per.connection': 1,
    }
}
–¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –∫–æ—Ç–æ—Ä—É—é –≤—ã —É–≤–∏–¥–∏—Ç–µ:
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è              Throughput   Avg Latency   Success Rate
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å   2850 msg/s    8.12 ms        99.5%
–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å       850 msg/s   45.67 ms       100.0%
–ù–∏–∑–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞             3100 msg/s    5.23 ms        98.9%
–ù–µ—Ç "—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π" –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏! –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –∑–∞–¥–∞—á–∏.


# ============================================
# 2. –ë–ê–ó–û–í–´–ô –ü–†–û–î–Æ–°–ï–†
# ============================================

echo "–°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π –ø—Ä–æ–¥—é—Å–µ—Ä..."

# 2.1. –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª basic_producer.py
cat > basic_producer.py << 'EOF'
#!/usr/bin/env python3
"""
–ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–¥—é—Å–µ—Ä Kafka –Ω–∞ Python
–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (acks)
"""

from confluent_kafka import Producer
import json
import time
from datetime import datetime
from faker import Faker

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Faker –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
fake = Faker('ru_RU')

class BasicProducer:
    def __init__(self, bootstrap_servers, acks='all'):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–¥—é—Å–µ—Ä–∞
        
        Args:
            bootstrap_servers: —Å—Ç—Ä–æ–∫–∞ —Å –∞–¥—Ä–µ—Å–∞–º–∏ –±—Ä–æ–∫–µ—Ä–æ–≤
            acks: —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (0, 1, 'all')
        """
        self.config = {
            'bootstrap.servers': bootstrap_servers,
            'acks': acks,  # –£—Ä–æ–≤–µ–Ω—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            'retries': 5,  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
            'retry.backoff.ms': 100,  # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
            'linger.ms': 5,  # –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –±–∞—Ç—á–∞
            'batch.size': 16384,  # –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ –≤ –±–∞–π—Ç–∞—Ö
            'compression.type': 'snappy',  # –°–∂–∞—Ç–∏–µ
        }
        
        self.producer = Producer(self.config)
        self.delivered_count = 0
        self.failed_count = 0
        
    def delivery_report(self, err, msg):
        """
        Callback-—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
        """
        if err is not None:
            self.failed_count += 1
            print(f'‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏: {err}')
        else:
            self.delivered_count += 1
            if self.delivered_count % 100 == 0:
                print(f'‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {self.delivered_count}')
                
    def generate_order_event(self, order_id):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–±—ã—Ç–∏—è –∑–∞–∫–∞–∑–∞"""
        return {
            'order_id': order_id,
            'customer': fake.name(),
            'email': fake.email(),
            'amount': round(fake.random_number(digits=4) / 100, 2),
            'timestamp': datetime.now().isoformat(),
            'status': 'created',
            'items': [
                {
                    'product': fake.word(),
                    'quantity': fake.random_int(min=1, max=5),
                    'price': round(fake.random_number(digits=3) / 100, 2)
                }
                for _ in range(fake.random_int(min=1, max=3))
            ]
        }
    
    def produce(self, topic, num_messages=1000):
        """
        –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        
        Args:
            topic: –∏–º—è —Ç–æ–ø–∏–∫–∞
            num_messages: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        """
        print(f"\nüöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–¥—é—Å–µ—Ä–∞ —Å acks={self.config['acks']}")
        print(f"üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ {num_messages} —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ç–æ–ø–∏–∫ '{topic}'")
        
        start_time = time.time()
        
        for i in range(num_messages):
            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
            message = self.generate_order_event(i + 1)
            
            # –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ JSON
            value = json.dumps(message, ensure_ascii=False)
            
            # –ö–ª—é—á –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ order_id
            key = str(message['order_id'] % 3)  # –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ 3 –ø–∞—Ä—Ç–∏—Ü–∏—è–º
            
            # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å callback
            self.producer.produce(
                topic=topic,
                key=key,
                value=value,
                callback=self.delivery_report
            )
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –∫–∞–∂–¥—ã–µ 100 —Å–æ–æ–±—â–µ–Ω–∏–π
            if i % 100 == 0:
                self.producer.poll(0)
                
            # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏
            time.sleep(0.001)
        
        # –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        self.producer.flush()
        
        end_time = time.time()
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        duration = end_time - start_time
        throughput = num_messages / duration
        
        print(f"\nüìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–†–û–î–Æ–°–ï–†–ê (acks={self.config['acks']}):")
        print(f"   –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {num_messages}")
        print(f"   –£—Å–ø–µ—à–Ω–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: {self.delivered_count}")
        print(f"   –û—à–∏–±–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏: {self.failed_count}")
        print(f"   –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {duration:.2f} —Å–µ–∫")
        print(f"   –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: {throughput:.2f} —Å–æ–æ–±—â/—Å–µ–∫")
        
        return {
            'acks': self.config['acks'],
            'total': num_messages,
            'delivered': self.delivered_count,
            'failed': self.failed_count,
            'duration': duration,
            'throughput': throughput
        }

if __name__ == "__main__":
    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    BOOTSTRAP_SERVERS = "kafka1.lab:9092,kafka2.lab:9092,kafka3.lab:9092"
    TOPIC = "test-producer"
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ acks
    acks_levels = ['0', '1', 'all']
    results = []
    
    for acks in acks_levels:
        print(f"\n{'='*60}")
        print(f"–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –° acks = {acks}")
        print('='*60)
        
        producer = BasicProducer(BOOTSTRAP_SERVERS, acks=acks)
        result = producer.produce(TOPIC, num_messages=500)
        results.append(result)
        
        # –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
        time.sleep(2)
    
    # –í—ã–≤–æ–¥ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    print(f"\n{'='*60}")
    print("–°–†–ê–í–ù–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –ü–û –£–†–û–í–ù–Ø–ú acks")
    print('='*60)
    
    for result in results:
        print(f"\nacks={result['acks']}:")
        print(f"  –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: {result['throughput']:.2f} —Å–æ–æ–±—â/—Å–µ–∫")
        print(f"  –£—Å–ø–µ—à–Ω–æ: {result['delivered']}/{result['total']}")
        print(f"  –í—Ä–µ–º—è: {result['duration']:.2f} —Å–µ–∫")
EOF

# 2.2. –ó–∞–ø—É—Å–∫–∞–µ–º –±–∞–∑–æ–≤—ã–π –ø—Ä–æ–¥—é—Å–µ—Ä
echo "–ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π acks..."
python3 basic_producer.py


# ============================================
# 3. –ü–†–û–î–Æ–°–ï–† –° –†–ê–°–®–ò–†–ï–ù–ù–´–ú RETRY –ú–ï–•–ê–ù–ò–ó–ú–û–ú
# ============================================

echo "–°–æ–∑–¥–∞–µ–º –ø—Ä–æ–¥—é—Å–µ—Ä —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º retry –º–µ—Ö–∞–Ω–∏–∑–º–æ–º..."

# 3.1. –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª retry_producer.py
cat > retry_producer.py << 'EOF'
#!/usr/bin/env python3
"""
–ü—Ä–æ–¥—é—Å–µ—Ä —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º –º–µ—Ö–∞–Ω–∏–∑–º–æ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π retry
"""

from confluent_kafka import Producer, KafkaException
import json
import time
import random
from datetime import datetime
from math import exp
import logging

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

class RetryProducer:
    def __init__(self, bootstrap_servers):
        """
        –ü—Ä–æ–¥—é—Å–µ—Ä —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ retry –º–µ—Ö–∞–Ω–∏–∑–º–∞–º–∏
        
        Args:
            bootstrap_servers: —Å—Ç—Ä–æ–∫–∞ —Å –∞–¥—Ä–µ—Å–∞–º–∏ –±—Ä–æ–∫–µ—Ä–æ–≤
        """
        self.config = {
            'bootstrap.servers': bootstrap_servers,
            'acks': 'all',
            'retries': 10,  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
            'retry.backoff.ms': 100,
            'max.in.flight.requests.per.connection': 1,  # –î–ª—è exactly-once
            'enable.idempotence': True,  # –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
            'linger.ms': 5,
            'batch.size': 16384,
            'compression.type': 'lz4',
        }
        
        self.producer = Producer(self.config)
        self.stats = {
            'success': 0,
            'failed': 0,
            'retries': 0,
            'errors': {}
        }
        
    def exponential_backoff(self, attempt, max_delay=5000):
        """
        –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —Å –¥–∂–∏—Ç—Ç–µ—Ä–æ–º
        
        Args:
            attempt: –Ω–æ–º–µ—Ä –ø–æ–ø—ã—Ç–∫–∏ (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 0)
            max_delay: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
        """
        # –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: delay = base * 2^attempt
        delay = min(100 * (2 ** attempt), max_delay)
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å (–¥–∂–∏—Ç—Ç–µ—Ä) ¬±20%
        jitter = random.uniform(0.8, 1.2)
        delay = int(delay * jitter)
        
        return delay / 1000.0  # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Å–µ–∫—É–Ω–¥—ã
    
    def circuit_breaker(self, error_count, window_size=100, threshold=0.3):
        """
        –ü—Ä–æ—Å—Ç–æ–π Circuit Breaker –ø–∞—Ç—Ç–µ—Ä–Ω
        
        Args:
            error_count: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –≤ –æ–∫–Ω–µ
            window_size: —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞
            threshold: –ø–æ—Ä–æ–≥ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Ü–µ–ø–∏
        """
        error_rate = error_count / window_size
        return error_rate > threshold
    
    def delivery_report_with_retry(self, err, msg, metadata):
        """
        –£–ª—É—á—à–µ–Ω–Ω—ã–π callback —Å –ª–æ–≥–∏–∫–æ–π retry
        
        Args:
            err: –æ–±—ä–µ–∫—Ç –æ—à–∏–±–∫–∏ –∏–ª–∏ None
            msg: –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            metadata: –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
        """
        if err is not None:
            self.stats['failed'] += 1
            error_code = err.code()
            
            # –õ–æ–≥–∏—Ä—É–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏
            if error_code not in self.stats['errors']:
                self.stats['errors'][error_code] = 0
            self.stats['errors'][error_code] += 1
            
            # –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—à–∏–±–æ–∫
            if error_code in [-185, -195]:  # Timeout –æ—à–∏–±–∫–∏
                logger.warning(f"‚è±Ô∏è Timeout –æ—à–∏–±–∫–∞: {err}")
                # –ú–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Å –±–æ–ª—å—à–∏–º timeout
                
            elif error_code in [-187, -189]:  # –û—à–∏–±–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
                logger.error(f"üî¥ –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏: {err}")
                # –ù—É–∂–Ω–∞ –ø–∞—É–∑–∞ –∏ –ø–æ–≤—Ç–æ—Ä
                
            elif error_code == -192:  # –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                logger.critical(f"üîê –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {err}")
                # –ù–µ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º–∞—è –æ—à–∏–±–∫–∞
                
            else:
                logger.error(f"‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞: {err}")
                
        else:
            self.stats['success'] += 1
            if self.stats['success'] % 100 == 0:
                logger.info(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: {self.stats['success']}")
    
    def produce_with_manual_retry(self, topic, key, value, max_attempts=3):
        """
        –†—É—á–Ω–æ–π retry –º–µ—Ö–∞–Ω–∏–∑–º —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
        
        Args:
            topic: –∏–º—è —Ç–æ–ø–∏–∫–∞
            key: –∫–ª—é—á —Å–æ–æ–±—â–µ–Ω–∏—è
            value: –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            max_attempts: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
        """
        for attempt in range(max_attempts):
            try:
                # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
                self.producer.produce(
                    topic=topic,
                    key=key,
                    value=value,
                    callback=lambda err, msg: self.delivery_report_with_retry(
                        err, msg, {'attempt': attempt + 1}
                    )
                )
                
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏
                self.producer.poll(0)
                return True
                
            except KafkaException as e:
                self.stats['retries'] += 1
                logger.warning(f"üîÑ –ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_attempts} –Ω–µ —É–¥–∞–ª–∞—Å—å: {e}")
                
                # –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
                if attempt == max_attempts - 1:
                    logger.error(f"‚ùå –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ —É–¥–∞–ª–∏—Å—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è")
                    return False
                
                # –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π
                delay = self.exponential_backoff(attempt)
                logger.info(f"‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ {delay:.2f} —Å–µ–∫ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π...")
                time.sleep(delay)
        
        return False
    
    def send_batch_with_error_handling(self, topic, messages, batch_size=100):
        """
        –û—Ç–ø—Ä–∞–≤–∫–∞ –±–∞—Ç—á–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        
        Args:
            topic: –∏–º—è —Ç–æ–ø–∏–∫–∞
            messages: —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π (dict)
            batch_size: —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞
        """
        logger.info(f"üöÄ –ù–∞—á–∞–ª–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ {len(messages)} —Å–æ–æ–±—â–µ–Ω–∏–π")
        
        start_time = time.time()
        successful = 0
        failed = []
        
        for i, message in enumerate(messages):
            try:
                # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ JSON
                value = json.dumps(message, ensure_ascii=False)
                key = str(message.get('id', i))
                
                # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å —Ä—É—á–Ω—ã–º retry
                if self.produce_with_manual_retry(topic, key, value):
                    successful += 1
                else:
                    failed.append(message)
                
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –∫–∞–∂–¥—ã–µ batch_size —Å–æ–æ–±—â–µ–Ω–∏–π
                if i % batch_size == 0:
                    self.producer.flush()
                    
                # –ü—Ä–æ–≥—Ä–µ—Å—Å
                if i % 100 == 0:
                    logger.info(f"üìä –ü—Ä–æ–≥—Ä–µ—Å—Å: {i}/{len(messages)}")
                    
            except Exception as e:
                logger.error(f"üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
                failed.append(message)
        
        # –§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É
        self.producer.flush()
        end_time = time.time()
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        duration = end_time - start_time
        throughput = len(messages) / duration if duration > 0 else 0
        
        logger.info(f"\n{'='*60}")
        logger.info("üìà –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:")
        logger.info(f"   –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {len(messages)}")
        logger.info(f"   –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {successful}")
        logger.info(f"   –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å: {len(failed)}")
        logger.info(f"   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ retry: {self.stats['retries']}")
        logger.info(f"   –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {duration:.2f} —Å–µ–∫")
        logger.info(f"   –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: {throughput:.2f} —Å–æ–æ–±—â/—Å–µ–∫")
        
        # –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –æ—à–∏–±–æ–∫
        if self.stats['errors']:
            logger.info("   –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –æ—à–∏–±–æ–∫:")
            for code, count in self.stats['errors'].items():
                logger.info(f"     –ö–æ–¥ {code}: {count} —Ä–∞–∑")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–µ—É–¥–∞–≤—à–∏–µ—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ñ–∞–π–ª (Dead Letter Queue)
        if failed:
            dlq_file = f"failed_messages_{int(time.time())}.json"
            with open(dlq_file, 'w') as f:
                json.dump(failed, f, indent=2, ensure_ascii=False)
            logger.info(f"üíæ –ù–µ—É–¥–∞–≤—à–∏–µ—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ {dlq_file}")
        
        return {
            'total': len(messages),
            'successful': successful,
            'failed': len(failed),
            'retries': self.stats['retries'],
            'duration': duration,
            'throughput': throughput,
            'errors': self.stats['errors']
        }

def generate_test_messages(count=1000):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    messages = []
    for i in range(count):
        messages.append({
            'id': i + 1,
            'timestamp': datetime.now().isoformat(),
            'data': f"–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ {i + 1}",
            'value': random.random() * 1000,
            'metadata': {
                'source': 'test-producer',
                'attempt': 1
            }
        })
    return messages

if __name__ == "__main__":
    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    BOOTSTRAP_SERVERS = "kafka1.lab:9092,kafka2.lab:9092,kafka3.lab:9092"
    TOPIC = "test-producer"
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–¥—é—Å–µ—Ä
    producer = RetryProducer(BOOTSTRAP_SERVERS)
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    print("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π...")
    messages = generate_test_messages(1000)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
    result = producer.send_batch_with_error_handling(TOPIC, messages)
    
    print(f"\n{'='*60}")
    print("–†–ï–ó–£–õ–¨–¢–ê–¢–´ –†–ê–ë–û–¢–´ –ü–†–û–î–Æ–°–ï–†–ê –° RETRY:")
    print('='*60)
    print(f"–£—Å–ø–µ—à–Ω–æ: {result['successful']}/{result['total']}")
    print(f"Retry –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: {result['retries']}")
    print(f"–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: {result['throughput']:.2f} —Å–æ–æ–±—â/—Å–µ–∫")
    
    if result['errors']:
        print("–û—à–∏–±–∫–∏ –ø–æ —Ç–∏–ø–∞–º:")
        for code, count in result['errors'].items():
            print(f"  –ö–æ–¥ {code}: {count}")
EOF

# 3.2. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–¥—é—Å–µ—Ä —Å retry
echo "–ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–¥—é—Å–µ—Ä —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º retry –º–µ—Ö–∞–Ω–∏–∑–º–æ–º..."
python3 retry_producer.py


# ============================================
# 4. –ê–°–ò–ù–•–†–û–ù–ù–´–ô –ü–†–û–î–Æ–°–ï–† –° CALLBACK
# ============================================

echo "–°–æ–∑–¥–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø—Ä–æ–¥—é—Å–µ—Ä —Å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–º–∏ callback..."

# 4.1. –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª async_producer.py
cat > async_producer.py << 'EOF'
#!/usr/bin/env python3
"""
–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø—Ä–æ–¥—é—Å–µ—Ä —Å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–º–∏ callback —Ñ—É–Ω–∫—Ü–∏—è–º–∏
–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
"""

from confluent_kafka import Producer
import json
import time
import threading
import queue
from datetime import datetime
from collections import defaultdict
from rich.console import Console
from rich.table import Table
from rich.progress import Progress, SpinnerColumn, TextColumn, BarColumn
import statistics

console = Console()

class AsyncProducer:
    def __init__(self, bootstrap_servers, topic):
        """
        –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø—Ä–æ–¥—é—Å–µ—Ä —Å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
        
        Args:
            bootstrap_servers: —Å—Ç—Ä–æ–∫–∞ —Å –∞–¥—Ä–µ—Å–∞–º–∏ –±—Ä–æ–∫–µ—Ä–æ–≤
            topic: –∏–º—è —Ç–æ–ø–∏–∫–∞
        """
        self.config = {
            'bootstrap.servers': bootstrap_servers,
            'acks': 'all',
            'retries': 5,
            'linger.ms': 1,  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏
            'batch.size': 32768,  # –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞
            'compression.type': 'snappy',
            'queue.buffering.max.messages': 100000,  # –†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏
            'queue.buffering.max.ms': 1,
        }
        
        self.producer = Producer(self.config)
        self.topic = topic
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        self.stats = {
            'sent': 0,
            'confirmed': 0,
            'failed': 0,
            'latencies': [],
            'start_time': None,
            'end_time': None,
        }
        
        # –û—á–µ—Ä–µ–¥—å –¥–ª—è callback —Å–æ–±—ã—Ç–∏–π
        self.callback_queue = queue.Queue()
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback
        self.callback_thread = threading.Thread(target=self._process_callbacks, daemon=True)
        self.callback_thread.start()
        
    def _delivery_callback(self, err, msg):
        """
        Callback –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–æ—Å—Ç–∞–≤–∫–∏
        
        Args:
            err: –æ—à–∏–±–∫–∞ –∏–ª–∏ None
            msg: –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        """
        # –ü–æ–º–µ—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
        self.callback_queue.put({
            'err': err,
            'msg': msg,
            'timestamp': time.time()
        })
    
    def _process_callbacks(self):
        """–ü–æ—Ç–æ–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"""
        while True:
            try:
                result = self.callback_queue.get(timeout=1)
                
                if result['err']:
                    self.stats['failed'] += 1
                    
                    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
                    if result['err'].retriable():
                        console.print(f"[yellow]üîÑ Retriable error: {result['err']}[/yellow]")
                    else:
                        console.print(f"[red]‚ùå Fatal error: {result['err']}[/red]")
                else:
                    self.stats['confirmed'] += 1
                    
                    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º latency
                    if hasattr(result['msg'], '_timestamp'):
                        latency = time.time() - result['msg']._timestamp
                        self.stats['latencies'].append(latency)
                    
                    # –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –≤—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                    if self.stats['confirmed'] % 100 == 0:
                        self._print_progress()
                        
            except queue.Empty:
                continue
            except Exception as e:
                console.print(f"[red]üí• –û—à–∏–±–∫–∞ –≤ callback –ø–æ—Ç–æ–∫–µ: {e}[/red]")
    
    def _print_progress(self):
        """–í—ã–≤–æ–¥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"""
        if not self.stats['latencies']:
            return
            
        avg_latency = statistics.mean(self.stats['latencies'][-100:]) * 1000
        p95_latency = statistics.quantiles(self.stats['latencies'][-100:], n=20)[18] * 1000
        
        console.print(
            f"[cyan]üìä –ü—Ä–æ–≥—Ä–µ—Å—Å: –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ={self.stats['sent']}, "
            f"–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ={self.stats['confirmed']}, "
            f"–æ—à–∏–±–æ–∫={self.stats['failed']}, "
            f"latency(avg)={avg_latency:.2f}ms, "
            f"latency(p95)={p95_latency:.2f}ms[/cyan]"
        )
    
    def generate_message(self, message_id):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        return {
            'id': message_id,
            'timestamp': datetime.now().isoformat(),
            'payload': 'x' * 100,  # 100 –±–∞–π—Ç –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
            'sequence': message_id,
            'source': 'async-producer'
        }
    
    def produce_async(self, num_messages=10000, batch_size=1000):
        """
        –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        
        Args:
            num_messages: –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
            batch_size: —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        """
        console.print(f"\n[bold green]üöÄ –ó–∞–ø—É—Å–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –ø—Ä–æ–¥—é—Å–µ—Ä–∞[/bold green]")
        console.print(f"üì§ –¢–æ–ø–∏–∫: {self.topic}")
        console.print(f"üì¶ –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {num_messages}")
        console.print(f"üéØ –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞: {batch_size}")
        
        self.stats['start_time'] = time.time()
        
        # –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
        with Progress(
            SpinnerColumn(),
            TextColumn("[progress.description]{task.description}"),
            BarColumn(),
            TextColumn("[progress.percentage]{task.percentage:>3.0f}%"),
            console=console
        ) as progress:
            task = progress.add_task("–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...", total=num_messages)
            
            for i in range(num_messages):
                # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
                message = self.generate_message(i + 1)
                value = json.dumps(message, ensure_ascii=False)
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º timestamp –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ latency
                msg_obj = type('obj', (object,), {'_timestamp': time.time()})
                
                # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
                self.producer.produce(
                    topic=self.topic,
                    key=str(i % 10),  # 10 —Ä–∞–∑–Ω—ã—Ö –∫–ª—é—á–µ–π
                    value=value,
                    callback=self._delivery_callback,
                    timestamp=int(time.time() * 1000)
                )
                
                self.stats['sent'] += 1
                
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –∫–∞–∂–¥—ã–µ batch_size —Å–æ–æ–±—â–µ–Ω–∏–π
                if i % batch_size == 0:
                    self.producer.poll(0)
                
                # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
                progress.update(task, advance=1)
                
                # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –¥–ª—è —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏
                if i % 1000 == 0:
                    time.sleep(0.001)
        
        # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        console.print("[yellow]‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏...[/yellow]")
        self.producer.flush()
        
        # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É callback
        time.sleep(2)
        
        self.stats['end_time'] = time.time()
        
        return self._generate_report()
    
    def _generate_report(self):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞"""
        duration = self.stats['end_time'] - self.stats['start_time']
        throughput = self.stats['sent'] / duration if duration > 0 else 0
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ latency
        if self.stats['latencies']:
            latencies_ms = [l * 1000 for l in self.stats['latencies']]
            avg_latency = statistics.mean(latencies_ms)
            min_latency = min(latencies_ms)
            max_latency = max(latencies_ms)
            p95_latency = statistics.quantiles(latencies_ms, n=20)[18]
        else:
            avg_latency = min_latency = max_latency = p95_latency = 0
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
        table = Table(title="üìä –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ê–°–ò–ù–•–†–û–ù–ù–û–ì–û –ü–†–û–î–Æ–°–ï–†–ê")
        
        table.add_column("–ú–µ—Ç—Ä–∏–∫–∞", style="cyan")
        table.add_column("–ó–Ω–∞—á–µ–Ω–∏–µ", style="green")
        
        table.add_row("–í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", str(self.stats['sent']))
        table.add_row("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ", str(self.stats['confirmed']))
        table.add_row("–û—à–∏–±–æ–∫", str(self.stats['failed']))
        table.add_row("–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è", f"{duration:.2f} —Å–µ–∫")
        table.add_row("–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å", f"{throughput:.2f} —Å–æ–æ–±—â/—Å–µ–∫")
        table.add_row("Avg Latency", f"{avg_latency:.2f} –º—Å")
        table.add_row("P95 Latency", f"{p95_latency:.2f} –º—Å")
        table.add_row("Min Latency", f"{min_latency:.2f} –º—Å")
        table.add_row("Max Latency", f"{max_latency:.2f} –º—Å")
        
        console.print(table)
        
        return {
            'sent': self.stats['sent'],
            'confirmed': self.stats['confirmed'],
            'failed': self.stats['failed'],
            'duration': duration,
            'throughput': throughput,
            'avg_latency': avg_latency,
            'p95_latency': p95_latency,
            'min_latency': min_latency,
            'max_latency': max_latency
        }

if __name__ == "__main__":
    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    BOOTSTRAP_SERVERS = "kafka1.lab:9092,kafka2.lab:9092,kafka3.lab:9092"
    TOPIC = "test-perf"
    
    # –°–æ–∑–¥–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø—Ä–æ–¥—é—Å–µ—Ä
    producer = AsyncProducer(BOOTSTRAP_SERVERS, TOPIC)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
    # –î–ª—è —Ç–µ—Å—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º 5000 —Å–æ–æ–±—â–µ–Ω–∏–π –±–∞—Ç—á–∞–º–∏ –ø–æ 500
    results = producer.produce_async(num_messages=5000, batch_size=500)
    
    console.print("\n[bold green]‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø—Ä–æ–¥—é—Å–µ—Ä –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É![/bold green]")
EOF

# 4.2. –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø—Ä–æ–¥—é—Å–µ—Ä
echo "–ó–∞–ø—É—Å–∫–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø—Ä–æ–¥—é—Å–µ—Ä —Å callback..."
python3 async_producer.py


# ============================================
# 5. –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò
# ============================================

echo "–°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏..."

# 5.1. –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª performance_test.py
cat > performance_test.py << 'EOF'
#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–¥—é—Å–µ—Ä–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏
–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
"""

from confluent_kafka import Producer
import json
import time
import statistics
from datetime import datetime
from rich.console import Console
from rich.table import Table
import threading

console = Console()

class PerformanceTester:
    def __init__(self, bootstrap_servers, topic):
        self.bootstrap_servers = bootstrap_servers
        self.topic = topic
        
    def create_producer(self, config_name, config):
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–¥—é—Å–µ—Ä–∞ —Å –∑–∞–¥–∞–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π"""
        base_config = {
            'bootstrap.servers': self.bootstrap_servers,
            'acks': 'all',
        }
        base_config.update(config)
        
        return Producer(base_config), config_name
    
    def run_test(self, producer, config_name, num_messages=10000, message_size=100):
        """
        –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        
        Args:
            producer: –æ–±—ä–µ–∫—Ç –ø—Ä–æ–¥—é—Å–µ—Ä–∞
            config_name: –∏–º—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            num_messages: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
            message_size: —Ä–∞–∑–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –±–∞–π—Ç–∞—Ö
        """
        console.print(f"\n[bold]üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {config_name}[/bold]")
        
        stats = {
            'sent': 0,
            'confirmed': 0,
            'failed': 0,
            'latencies': [],
            'start_time': None,
            'end_time': None,
        }
        
        # Callback –¥–ª—è —Å–±–æ—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        def delivery_callback(err, msg):
            if err:
                stats['failed'] += 1
            else:
                stats['confirmed'] += 1
                if hasattr(msg, '_timestamp'):
                    latency = time.time() - msg._timestamp
                    stats['latencies'].append(latency)
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        test_payload = 'x' * message_size
        
        stats['start_time'] = time.time()
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        for i in range(num_messages):
            message = {
                'id': i + 1,
                'timestamp': datetime.now().isoformat(),
                'payload': test_payload,
                'config': config_name,
                'sequence': i
            }
            
            value = json.dumps(message)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º timestamp
            msg_obj = type('obj', (object,), {'_timestamp': time.time()})
            
            producer.produce(
                topic=self.topic,
                key=str(i % 100),  # 100 —Ä–∞–∑–Ω—ã—Ö –∫–ª—é—á–µ–π –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
                value=value,
                callback=delivery_callback
            )
            
            stats['sent'] += 1
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –∫–∞–∂–¥—ã–µ 1000 —Å–æ–æ–±—â–µ–Ω–∏–π
            if i % 1000 == 0:
                producer.poll(0)
        
        # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
        producer.flush()
        stats['end_time'] = time.time()
        
        # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É callback
        time.sleep(1)
        
        # –†–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫
        duration = stats['end_time'] - stats['start_time']
        throughput = stats['sent'] / duration if duration > 0 else 0
        
        if stats['latencies']:
            latencies_ms = [l * 1000 for l in stats['latencies']]
            avg_latency = statistics.mean(latencies_ms)
            p95_latency = statistics.quantiles(latencies_ms, n=20)[18]
        else:
            avg_latency = p95_latency = 0
        
        return {
            'config': config_name,
            'sent': stats['sent'],
            'confirmed': stats['confirmed'],
            'failed': stats['failed'],
            'duration': duration,
            'throughput': throughput,
            'avg_latency': avg_latency,
            'p95_latency': p95_latency,
            'success_rate': stats['confirmed'] / stats['sent'] if stats['sent'] > 0 else 0
        }
    
    def run_all_tests(self):
        """–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"""
        console.print("[bold green]üöÄ –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò[/bold green]")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        test_configs = [
            ('–ë–∞–∑–æ–≤—ã–π', {
                'acks': 'all',
                'retries': 5,
                'linger.ms': 5,
                'batch.size': 16384,
            }),
            ('–í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', {
                'acks': '1',
                'retries': 3,
                'linger.ms': 1,
                'batch.size': 65536,
                'compression.type': 'snappy',
                'queue.buffering.max.messages': 100000,
            }),
            ('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å', {
                'acks': 'all',
                'retries': 10,
                'linger.ms': 20,
                'batch.size': 32768,
                'compression.type': 'lz4',
                'max.in.flight.requests.per.connection': 1,
                'enable.idempotence': True,
            }),
            ('–ù–∏–∑–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞', {
                'acks': '1',
                'retries': 2,
                'linger.ms': 0,
                'batch.size': 8192,
                'compression.type': 'none',
                'queue.buffering.max.ms': 0,
            }),
            ('–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π', {
                'acks': 'all',
                'retries': 5,
                'linger.ms': 10,
                'batch.size': 131072,
                'compression.type': 'gzip',
                'message.max.bytes': 1048576,
            }),
        ]
        
        results = []
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        for config_name, config in test_configs:
            producer, name = self.create_producer(config_name, config)
            result = self.run_test(producer, name, num_messages=2000, message_size=500)
            results.append(result)
            
            # –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
            time.sleep(2)
        
        # –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        self.print_results_table(results)
        
        # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        self.print_recommendations(results)
        
        return results
    
    def print_results_table(self, results):
        """–í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü—ã"""
        table = Table(title="üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò")
        
        table.add_column("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è", style="cyan", no_wrap=True)
        table.add_column("–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å", style="green", justify="right")
        table.add_column("Avg Latency", style="magenta", justify="right")
        table.add_column("P95 Latency", style="yellow", justify="right")
        table.add_column("–£—Å–ø–µ—à–Ω–æ—Å—Ç—å", style="blue", justify="right")
        table.add_column("–í—Ä–µ–º—è", style="white", justify="right")
        
        for result in results:
            table.add_row(
                result['config'],
                f"{result['throughput']:.2f} —Å–æ–æ–±—â/—Å–µ–∫",
                f"{result['avg_latency']:.2f} –º—Å",
                f"{result['p95_latency']:.2f} –º—Å",
                f"{result['success_rate']*100:.1f}%",
                f"{result['duration']:.2f} —Å–µ–∫"
            )
        
        console.print(table)
    
    def print_recommendations(self, results):
        """–í—ã–≤–æ–¥ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"""
        console.print("\n[bold]üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò:[/bold]")
        
        # –ù–∞—Ö–æ–¥–∏–º –ª—É—á—à—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–æ –∫–∞–∂–¥–æ–º—É –ø–∞—Ä–∞–º–µ—Ç—Ä—É
        best_throughput = max(results, key=lambda x: x['throughput'])
        best_latency = min(results, key=lambda x: x['avg_latency'])
        best_reliability = max(results, key=lambda x: x['success_rate'])
        
        console.print(f"\n‚úÖ –î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ({best_throughput['throughput']:.2f} —Å–æ–æ–±—â/—Å–µ–∫):")
        console.print(f"   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é: [green]{best_throughput['config']}[/green]")
        console.print(f"   –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –º–µ—Ç—Ä–∏–∫–∏, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞")
        
        console.print(f"\n‚ö° –î–ª—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ ({best_latency['avg_latency']:.2f} –º—Å):")
        console.print(f"   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é: [cyan]{best_latency['config']}[/cyan]")
        console.print(f"   –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è: —Ä–µ–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —á–∞—Ç—ã, –æ–Ω–ª–∞–π–Ω-–∏–≥—Ä—ã")
        
        console.print(f"\nüõ°Ô∏è –î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ ({best_reliability['success_rate']*100:.1f}%):")
        console.print(f"   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é: [yellow]{best_reliability['config']}[/yellow]")
        console.print(f"   –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è: —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∑–∞–∫–∞–∑—ã, critical –¥–∞–Ω–Ω—ã–µ")
        
        console.print(f"\n[bold]üìù –û–ë–©–ò–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:[/bold]")
        console.print("1. –î–ª—è –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∂–∞—Ç–∏–µ (snappy/lz4)")
        console.print("2. –î–ª—è exactly-once —Å–µ–º–∞–Ω—Ç–∏–∫–∏ –≤–∫–ª—é—á–∞–π—Ç–µ enable.idempotence")
        console.print("3. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–π—Ç–µ batch.size –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π")
        console.print("4. –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ latency –∏ throughput –≤ production")
        console.print("5. –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ–¥ –≤–∞—à—É –Ω–∞–≥—Ä—É–∑–∫—É")

if __name__ == "__main__":
    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    BOOTSTRAP_SERVERS = "kafka1.lab:9092,kafka2.lab:9092,kafka3.lab:9092"
    TOPIC = "test-perf"
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
    tester = PerformanceTester(BOOTSTRAP_SERVERS, TOPIC)
    results = tester.run_all_tests()
    
    console.print("\n[bold green]‚úÖ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û![/bold green]")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ —Ñ–∞–π–ª
    import csv
    with open('performance_results.csv', 'w', newline='') as csvfile:
        fieldnames = ['config', 'throughput', 'avg_latency', 'p95_latency', 'success_rate', 'duration']
        writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
        
        writer.writeheader()
        for result in results:
            writer.writerow({
                'config': result['config'],
                'throughput': result['throughput'],
                'avg_latency': result['avg_latency'],
                'p95_latency': result['p95_latency'],
                'success_rate': result['success_rate'],
                'duration': result['duration']
            })
    
    console.print(f"üìÅ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ performance_results.csv")
EOF

# 5.2. –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
echo "–ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏..."
python3 performance_test.py


# ============================================
# 6. –ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –í KAFKA
# ============================================

echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Kafka..."

# 6.1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ç–æ–ø–∏–∫–∞—Ö (–Ω–æ–≤—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–ª—è Kafka 4.x)
echo "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ç–æ–ø–∏–∫–∞—Ö:"
/opt/kafka/bin/kafka-run-class.sh kafka.admin.ConsumerGroupCommand \
  --bootstrap-server localhost:9092 \
  --group test-offset-checker \
  --topic test-producer \
  --describe 2>/dev/null | awk '/test-producer/ {sum += $3} END {print "test-producer:", sum}' || \
  echo "test-producer: –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Å–æ–∑–¥–∞–π—Ç–µ consumer group"

# –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —á–µ—Ä–µ–∑ GetOffsetShell (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ –≤–∞—à–µ–π –≤–µ—Ä—Å–∏–∏)
# –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–∏–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ—ë –≤–º–µ—Å—Ç–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–π
/opt/kafka/bin/kafka-get-offsets.sh --bootstrap-server localhost:9092 --topic test-producer --time -1 2>/dev/null | \
  awk -F ":" '{sum += $3} END {print "test-producer:", sum}' || \
  echo "test-producer: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –ø–æ–¥—Å—á–µ—Ç–∞"

# 6.2. –ü—Ä–æ—Å—Ç–æ–π –ø–æ–¥—Å—á–µ—Ç —á–µ—Ä–µ–∑ consumer (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±)
echo "–ë—ã—Å—Ç—Ä—ã–π –ø–æ–¥—Å—á–µ—Ç —á–µ—Ä–µ–∑ consumer (–ø–µ—Ä–≤—ã–µ 1000 —Å–æ–æ–±—â–µ–Ω–∏–π):"
timeout 10 /opt/kafka/bin/kafka-console-consumer.sh \
  --topic test-producer \
  --bootstrap-server localhost:9092 \
  --from-beginning \
  --max-messages 1000 2>/dev/null | wc -l | xargs echo "–ù–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ test-producer:"

# 6.3. –ü—Ä–æ–≤–µ—Ä—è–µ–º consumer groups
echo "Consumer groups:"
/opt/kafka/bin/kafka-consumer-groups.sh \
  --bootstrap-server localhost:9092 \
  --list 2>/dev/null || echo "Consumer groups –Ω–µ –Ω–∞–π–¥–µ–Ω—ã (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –ø—Ä–æ–¥—é—Å–µ—Ä–æ–≤)"

# 6.4. –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–ø–∏–∫–∞—Ö
echo "–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–ø–∏–∫–∞—Ö:"
/opt/kafka/bin/kafka-topics.sh --describe \
  --topic test-producer \
  --bootstrap-server localhost:9092

/opt/kafka/bin/kafka-topics.sh --describe \
  --topic test-perf \
  --bootstrap-server localhost:9092

# 6.5. –ß–∏—Ç–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
echo "–ß–∏—Ç–∞–µ–º 3 —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ test-producer:"
timeout 5 /opt/kafka/bin/kafka-console-consumer.sh \
  --topic test-producer \
  --bootstrap-server localhost:9092 \
  --from-beginning \
  --max-messages 3 \
  --timeout-ms 5000 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è"

echo "–ß–∏—Ç–∞–µ–º 3 —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ test-perf:"
timeout 5 /opt/kafka/bin/kafka-console-consumer.sh \
  --topic test-perf \
  --bootstrap-server localhost:9092 \
  --from-beginning \
  --max-messages 3 \
  --timeout-ms 5000 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è"

# 6.6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ —É—Ç–∏–ª–∏—Ç—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ª–æ–≥–æ–≤ –Ω–∞ –¥–∏—Å–∫–µ:"
sudo du -sh /opt/kafka/data/*test* 2>/dev/null | head -5

echo "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –ª–æ–≥–æ–≤:"
find /opt/kafka/data -name "*.log" -name "*test*" 2>/dev/null | wc -l | xargs echo "–§–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤:"

# ============================================
# 7. –û–ß–ò–°–¢–ö–ê –ò –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï
# ============================================

echo "=== –õ–ê–ë–û–†–ê–¢–û–†–ù–ê–Ø 2.2 –ó–ê–í–ï–†–®–ï–ù–ê ==="
echo ""
echo "‚úÖ –ü–†–û–í–ï–†–¨–¢–ï, –ß–¢–û –í–´ –í–´–ü–û–õ–ù–ò–õ–ò:"
echo "   1. –£—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ Python –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
echo "   2. –ó–∞–ø—É—Å—Ç–∏–ª–∏ basic_producer.py (—Ç–µ—Å—Ç acks —É—Ä–æ–≤–Ω–µ–π)"
echo "   3. –ó–∞–ø—É—Å—Ç–∏–ª–∏ retry_producer.py (–º–µ—Ö–∞–Ω–∏–∑–º—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏)"
echo "   4. –ó–∞–ø—É—Å—Ç–∏–ª–∏ async_producer.py (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞)"
echo "   5. –ó–∞–ø—É—Å—Ç–∏–ª–∏ performance_test.py (—Ç–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)"
echo "   6. –ü—Ä–æ–≤–µ—Ä–∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —á–µ—Ä–µ–∑ verify_production.py"
echo ""
echo "üìä –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´:"
echo "   - –°–æ–æ–±—â–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ Kafka"
echo "   - –†–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ acks –≤–ª–∏—è—é—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å"
echo "   - Retry –º–µ—Ö–∞–Ω–∏–∑–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∏ —Å–±–æ—è—Ö"
echo "   - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å"
echo "   - –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"
echo ""
echo "üîß –î–õ–Ø –£–ì–õ–£–ë–õ–ï–ù–ù–û–ì–û –ò–ó–£–ß–ï–ù–ò–Ø:"
echo "   1. –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏ batch.size –∏ linger.ms"
echo "   2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã —Å–∂–∞—Ç–∏—è (none, gzip, snappy, lz4, zstd)"
echo "   3. –†–µ–∞–ª–∏–∑—É–π—Ç–µ exactly-once —Å–µ–º–∞–Ω—Ç–∏–∫—É —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏"
echo "   4. –î–æ–±–∞–≤—å—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–¥—é—Å–µ—Ä–∞ –≤ Grafana —á–µ—Ä–µ–∑ JMX"
echo "   5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–∞—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"
echo ""
echo "üõ†Ô∏è  –£–°–¢–†–ê–ù–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú:"
echo "   –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥—ã Kafka –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç:"
echo "   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä—Å–∏—é: /opt/kafka/bin/kafka-topics.sh --version"
echo "   2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ --help –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞: /opt/kafka/bin/kafka-topics.sh --help"
echo "   3. –î–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Python-—Å–∫—Ä–∏–ø—Ç verify_production.py"
echo ""
echo "üìö –ü–û–õ–ï–ó–ù–´–ï –°–°–´–õ–ö–ò:"
echo "   - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è confluent-kafka-python: https://github.com/confluentinc/confluent-kafka-python"
echo "   - Kafka Producer Configs: https://kafka.apache.org/documentation/#producerconfigs"
echo "   - Best Practices: https://www.confluent.io/blog/apache-kafka-producer-improvements-sticky-partitioner/"
echo ""
echo "–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è 2.3 ‚Äî –ö–æ–Ω—Å—é–º–µ—Ä—ã Kafka"



–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–¥—é—Å–µ—Ä–æ–≤
–î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º Python-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:
# –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª verify_production.py
cat > verify_production.py << 'EOF'
#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–¥—é—Å–µ—Ä–æ–≤
"""

from confluent_kafka import Consumer, KafkaError
import json
import time
from rich.console import Console
from rich.table import Table
from rich.progress import Progress

console = Console()

def verify_topic_messages(bootstrap_servers, topic_name, max_messages=1000):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ç–æ–ø–∏–∫–µ"""
    console.print(f"\n[bold cyan]üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ø–∏–∫–∞: {topic_name}[/bold cyan]")
    
    config = {
        'bootstrap.servers': bootstrap_servers,
        'group.id': f'verify-{topic_name}-{int(time.time())}',
        'auto.offset.reset': 'earliest',
        'enable.auto.commit': False,
        'session.timeout.ms': 10000,
    }
    
    consumer = Consumer(config)
    consumer.subscribe([topic_name])
    
    messages = []
    start_time = time.time()
    
    try:
        with Progress() as progress:
            task = progress.add_task(f"–ß—Ç–µ–Ω–∏–µ {topic_name}...", total=max_messages)
            
            while len(messages) < max_messages:
                msg = consumer.poll(timeout=1.0)
                
                if msg is None:
                    continue
                if msg.error():
                    if msg.error().code() == KafkaError._PARTITION_EOF:
                        break
                    else:
                        console.print(f"[red]–û—à–∏–±–∫–∞: {msg.error()}[/red]")
                        break
                
                try:
                    # –ü—ã—Ç–∞–µ–º—Å—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å JSON
                    value = msg.value().decode('utf-8')
                    data = json.loads(value)
                    messages.append(data)
                    
                    # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    progress.update(task, advance=1)
                    
                except (json.JSONDecodeError, UnicodeDecodeError) as e:
                    console.print(f"[yellow]‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}[/yellow]")
                
                # –ü—Ä–µ—Ä—ã–≤–∞–µ–º –µ—Å–ª–∏ –¥–æ–ª–≥–æ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
                if time.time() - start_time > 10:
                    break
        
        consumer.close()
        
        # –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        if messages:
            console.print(f"[green]‚úÖ –ù–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {len(messages)}[/green]")
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –ø–µ—Ä–≤—ã–º 3 —Å–æ–æ–±—â–µ–Ω–∏—è–º
            console.print("\n[bold]–ü—Ä–∏–º–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π:[/bold]")
            for i, msg in enumerate(messages[:3]):
                console.print(f"[cyan]–°–æ–æ–±—â–µ–Ω–∏–µ {i+1}:[/cyan]")
                if isinstance(msg, dict):
                    for key, value in list(msg.items())[:5]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 5 –ø–æ–ª–µ–π
                        console.print(f"  {key}: {value}")
                    if len(msg) > 5:
                        console.print(f"  ... –∏ –µ—â–µ {len(msg) - 5} –ø–æ–ª–µ–π")
                else:
                    console.print(f"  {msg}")
                console.print("")
            
            # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            if isinstance(messages[0], dict):
                keys = set()
                for msg in messages[:100]:  # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ 100 —Å–æ–æ–±—â–µ–Ω–∏–π
                    if isinstance(msg, dict):
                        keys.update(msg.keys())
                
                console.print(f"[bold]–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–µ—Ä–≤—ã–º 100 —Å–æ–æ–±—â–µ–Ω–∏—è–º:[/bold]")
                console.print(f"  –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π: {len(keys)}")
                console.print(f"  –ü—Ä–∏–º–µ—Ä –ø–æ–ª–µ–π: {', '.join(list(keys)[:5])}")
        
        else:
            console.print("[yellow]‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã[/yellow]")
            
        return len(messages)
        
    except Exception as e:
        console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–æ–ø–∏–∫–∞: {e}[/red]")
        return 0

def check_topic_info(bootstrap_servers, topic_name):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–ø–∏–∫–µ"""
    console.print(f"\n[bold]üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–ø–∏–∫–µ {topic_name}:[/bold]")
    
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º CLI –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–ø–∏–∫–µ
        import subprocess
        result = subprocess.run(
            ['/opt/kafka/bin/kafka-topics.sh', '--describe',
             '--topic', topic_name, '--bootstrap-server', bootstrap_servers],
            capture_output=True,
            text=True,
            timeout=5
        )
        
        if result.returncode == 0:
            lines = result.stdout.strip().split('\n')
            for line in lines:
                if 'Topic:' in line or 'PartitionCount:' in line:
                    console.print(f"  {line.strip()}")
        else:
            console.print(f"  [yellow]–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é[/yellow]")
            
    except Exception as e:
        console.print(f"  [yellow]–û—à–∏–±–∫–∞: {e}[/yellow]")

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏"""
    console.print("[bold green]üî¨ –ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –†–ê–ë–û–¢–´ –ü–†–û–î–Æ–°–ï–†–û–í[/bold green]")
    console.print("=" * 60)
    
    bootstrap_servers = "localhost:9092"
    topics = ['test-producer', 'test-perf']
    
    total_messages = 0
    
    for topic in topics:
        check_topic_info(bootstrap_servers, topic)
        count = verify_topic_messages(bootstrap_servers, topic, max_messages=500)
        total_messages += count
    
    # –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞
    table = Table(title="üìà –ò–¢–û–ì–ò –ü–†–û–í–ï–†–ö–ò")
    table.add_column("–¢–æ–ø–∏–∫", style="cyan")
    table.add_column("–ù–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π", style="green", justify="right")
    table.add_column("–°—Ç–∞—Ç—É—Å", style="yellow")
    
    for topic in topics:
        # –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ - –≤ —Ä–µ–∞–ª—å–Ω–æ–º —Å–∫—Ä–∏–ø—Ç–µ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        status = "‚úÖ OK" if topic == 'test-producer' else "‚ö†Ô∏è –ù—É–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞"
        table.add_row(topic, "500+", status)
    
    console.print(table)
    
    console.print("\n[bold]üéØ –í–´–í–û–î–´:[/bold]")
    console.print("1. –ü—Ä–æ–¥—é—Å–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Å–æ–æ–±—â–µ–Ω–∏—è")
    console.print("2. –°–æ–æ–±—â–µ–Ω–∏—è –∏–º–µ—é—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON")
    console.print("3. –î–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–µ—Ä–∏–∞–ª–∏–∑—É—é—Ç—Å—è/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑—É—é—Ç—Å—è")
    console.print("4. Kafka —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è")
    
    console.print("\n[bold green]‚úÖ –ü–†–û–í–ï–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û![/bold green]")

if __name__ == "__main__":
    main()
EOF

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
echo "–ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..."
python3 verify_production.py

–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è:
–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç: –ó–∞–ø—É—Å—Ç–∏—Ç–µ basic_producer.py –∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –æ–¥–∏–Ω –±—Ä–æ–∫–µ—Ä Kafka. –ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –ø—Ä–∏ —Ä–∞–∑–Ω—ã—Ö acks?
–ê–Ω–∞–ª–∏–∑: –í performance_test.py –∏–∑–º–µ–Ω–∏—Ç–µ message_size —Å 100 –Ω–∞ 10000 –±–∞–π—Ç. –ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—Å—è throughput?
–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –í async_producer.py –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è batch.size. –ö–∞–∫–æ–µ –¥–∞—ë—Ç –ª—É—á—à—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å?
–î–æ—Ä–∞–±–æ—Ç–∫–∞: –î–æ–±–∞–≤—å—Ç–µ –≤ retry_producer.py –æ—Ç–ø—Ä–∞–≤–∫—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ Prometheus.